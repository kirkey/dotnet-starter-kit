<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" Model="@Model">
            <MudGrid>
                @if (!IsRecording)
                {
                    <MudItem xs="12">
                        <AutocompleteItem @bind-Value="Model.ItemId"
                                         For="@(() => Model.ItemId)"
                                         Label="Item"
                                         Variant="Variant.Filled"
                                         Required="true" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudNumericField @bind-Value="Model.SystemQuantity"
                                         Label="System Quantity"
                                         For="@(() => Model.SystemQuantity)"
                                         Format="N2"
                                         Required="true"
                                         Min="0"
                                         Variant="Variant.Filled"
                                         HelperText="Current quantity in the system" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudNumericField T="int?" @bind-Value="Model.CountedQuantity"
                                         Label="Counted Quantity (Optional)"
                                         For="@(() => Model.CountedQuantity)"
                                         Format="N2"
                                         Min="0"
                                         Variant="Variant.Filled"
                                         HelperText="Can be recorded later" />
                    </MudItem>
                }
                else
                {
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Info" Dense="true">
                            Recording count for item. System Quantity: <strong>@Model.SystemQuantity</strong>
                        </MudAlert>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudNumericField T="int?" @bind-Value="Model.CountedQuantity"
                                         Label="Counted Quantity"
                                         For="@(() => Model.CountedQuantity)"
                                         Format="N2"
                                         Required="true"
                                         Min="0"
                                         Variant="Variant.Filled"
                                         HelperText="Enter the physical count" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="Model.CountedBy"
                                      Label="Counted By"
                                      For="@(() => Model.CountedBy)"
                                      Variant="Variant.Filled"
                                      HelperText="Person who performed the count" />
                    </MudItem>

                    @if (Model.CountedQuantity.HasValue)
                    {
                        var variance = Model.CountedQuantity.Value - Model.SystemQuantity;
                        var color = variance == 0 ? Color.Success : (variance > 0 ? Color.Info : Color.Error);
                        <MudItem xs="12">
                            <MudAlert Severity="@GetSeverity(variance)" Dense="true">
                                <strong>Variance: @(variance > 0 ? "+" : "")@variance</strong>
                                @if (variance == 0)
                                {
                                    <span> - Count matches system quantity!</span>
                                }
                                else if (variance > 0)
                                {
                                    <span> - Physical count is higher than system</span>
                                }
                                else
                                {
                                    <span> - Physical count is lower than system</span>
                                }
                            </MudAlert>
                        </MudItem>
                    }
                }

                <MudItem xs="12">
                    <MudTextField @bind-Value="Model.Notes"
                                  Label="Notes"
                                  For="@(() => Model.Notes)"
                                  Lines="3"
                                  Variant="Variant.Filled"
                                  HelperText="Additional information about this count" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => Cancel())">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="@(() => SaveAsync())" Variant="Variant.Filled">
            @(IsRecording ? "Record Count" : "Add Item")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private Severity GetSeverity(int variance)
    {
        if (variance == 0) return Severity.Success;
        if (variance > 0) return Severity.Info;
        return Severity.Warning;
    }
}
