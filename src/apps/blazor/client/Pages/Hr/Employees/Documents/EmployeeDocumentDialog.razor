@namespace FSH.Starter.Blazor.Client.Pages.Hr.Employees.Documents

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.h6">@(IsCreate ? "Upload Document" : "Edit Document")</MudText>

            <MudGrid Spacing="2">
                <MudItem xs="12">
                    <MudSelect T="string"
                               @bind-Value="_documentType"
                               Label="Document Type"
                               Variant="Variant.Filled"
                               Required="true">
                        <MudSelectItem Value="@("Contract")">Contract</MudSelectItem>
                        <MudSelectItem Value="@("Certification")">Certification</MudSelectItem>
                        <MudSelectItem Value="@("License")">License</MudSelectItem>
                        <MudSelectItem Value="@("Identity")">Identity Document</MudSelectItem>
                        <MudSelectItem Value="@("Medical")">Medical Certificate</MudSelectItem>
                        <MudSelectItem Value="@("Other")">Other</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_title"
                                  Label="Document Title"
                                  Variant="Variant.Filled"
                                  Required="true"
                                  HelperText="e.g., Employment Contract, Driver's License" />
                </MudItem>

                @if (IsCreate)
                {
                    <MudItem xs="12">
                        <MudFileUpload T="IBrowserFile"
                                       @bind-Files="_selectedFile"
                                       Accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                                       MaximumFileCount="1"
                                       OnFilesChanged="OnFileSelected">
                            <ActivatorContent>
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.CloudUpload"
                                           FullWidth="true">
                                    @(_selectedFile != null ? _selectedFile.Name : "Choose File")
                                </MudButton>
                            </ActivatorContent>
                        </MudFileUpload>
                        <MudText Typo="Typo.caption" Class="mt-1">
                            Supported formats: PDF, Word, JPG, PNG (Max 10MB)
                        </MudText>
                    </MudItem>
                }
                else if (!string.IsNullOrWhiteSpace(_fileName))
                {
                    <MudItem xs="12">
                        <MudTextField Value="_fileName"
                                      Label="Current File"
                                      Variant="Variant.Filled"
                                      ReadOnly="true"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.AttachFile" />
                    </MudItem>
                }

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_issueNumber"
                                  Label="Issue Number"
                                  Variant="Variant.Filled"
                                  HelperText="License #, Certificate #, etc." />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudDatePicker @bind-Date="_issueDate"
                                   Label="Issue Date"
                                   Variant="Variant.Filled"
                                   MaxDate="DateTime.Today" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudDatePicker @bind-Date="_expiryDate"
                                   Label="Expiry Date"
                                   Variant="Variant.Filled"
                                   MinDate="DateTime.Today"
                                   Clearable="true"
                                   HelperText="Leave blank if document doesn't expire" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_notes"
                                  Label="Notes"
                                  Lines="3"
                                  Variant="Variant.Filled"
                                  HelperText="Additional information or comments" />
                </MudItem>
            </MudGrid>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => Cancel())">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@(() => SaveDocument())" Disabled="_saving">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
            }
            else
            {
                @(IsCreate ? "Upload" : "Update")
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public bool IsCreate { get; set; } = true;

    [Parameter]
    public DefaultIdType EmployeeId { get; set; }

    [Parameter]
    public EmployeeDocumentResponse? ExistingDocument { get; set; }

    private string _documentType = "Other";
    private string? _title;
    private string? _issueNumber;
    private DateTime? _issueDate;
    private DateTime? _expiryDate;
    private string? _notes;
    private string? _fileName;
    private string? _filePath;
    private long? _fileSize;
    private IBrowserFile? _selectedFile;
    private bool _saving;

    protected override void OnInitialized()
    {
        if (!IsCreate && ExistingDocument != null)
        {
            _documentType = ExistingDocument.DocumentType ?? "Other";
            _title = ExistingDocument.Title;
            _issueNumber = ExistingDocument.IssueNumber;
            _issueDate = ExistingDocument.IssueDate;
            _expiryDate = ExistingDocument.ExpiryDate;
            _notes = ExistingDocument.Notes;
            _fileName = ExistingDocument.FileName;
            _filePath = ExistingDocument.FilePath;
            _fileSize = ExistingDocument.FileSize;
        }
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
    }

    private async Task SaveDocument()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_title))
            {
                Snackbar?.Add("Document title is required", Severity.Warning);
                return;
            }

            if (IsCreate && _selectedFile == null)
            {
                Snackbar?.Add("Please select a file to upload", Severity.Warning);
                return;
            }

            if (_selectedFile != null && _selectedFile.Size > 10 * 1024 * 1024)
            {
                Snackbar?.Add("File size must not exceed 10MB", Severity.Warning);
                return;
            }

            _saving = true;

            if (IsCreate)
            {
                string? fileData = null;
                string? fileName = null;
                long? fileSize = null;

                if (_selectedFile != null)
                {
                    fileName = _selectedFile.Name;
                    fileSize = _selectedFile.Size;

                    // Read file as base64
                    using var stream = _selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
                    using var ms = new MemoryStream();
                    await stream.CopyToAsync(ms);
                    var bytes = ms.ToArray();
                    fileData = Convert.ToBase64String(bytes);
                }

                var command = new CreateEmployeeDocumentCommand
                {
                    EmployeeId = EmployeeId,
                    DocumentType = _documentType,
                    Title = _title!,
                    FileName = fileName,
                    FilePath = fileData, // Using FilePath to store base64 data temporarily
                    FileSize = fileSize,
                    IssueNumber = _issueNumber,
                    IssueDate = _issueDate,
                    ExpiryDate = _expiryDate,
                    Notes = _notes
                };

                await Client.CreateEmployeeDocumentEndpointAsync("1", command);
                Snackbar?.Add("Document uploaded successfully", Severity.Success);
            }
            else if (ExistingDocument != null)
            {
                var command = new UpdateEmployeeDocumentCommand
                {
                    DocumentType = _documentType,
                    Title = _title!,
                    IssueNumber = _issueNumber,
                    IssueDate = _issueDate,
                    ExpiryDate = _expiryDate,
                    Notes = _notes
                };

                await Client.UpdateEmployeeDocumentEndpointAsync("1", ExistingDocument.Id, command);
                Snackbar?.Add("Document updated successfully", Severity.Success);
            }

            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar?.Add($"Error saving document: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private Task Cancel()
    {
        MudDialog.Cancel();
        return Task.CompletedTask;
    }
}

