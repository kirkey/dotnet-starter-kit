@namespace FSH.Starter.Blazor.Client.Pages.Hr.Employees.Documents

<MudPaper Elevation="@_preference.Elevation" Class="pa-4 mb-4">
    <MudStack Spacing="3">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudText Typo="Typo.subtitle2">Employee Documents</MudText>
            <MudButton StartIcon="@Icons.Material.Filled.Add" Size="Size.Small" Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => AddDocument())">
                Upload Document
            </MudButton>
        </MudStack>

        @if (_documents.Count == 0)
        {
            <MudAlert Severity="Severity.Info">No documents uploaded yet. Click "Upload Document" to add one.</MudAlert>
        }
        else
        {
            <MudList T="EmployeeDocumentResponse" Clickable="false" Dense="true">
                @foreach (var document in _documents)
                {
                    var isExpired = document.ExpiryDate.HasValue && document.ExpiryDate < DateTime.Today;
                    var isExpiringSoon = document.ExpiryDate.HasValue && !isExpired && 
                                        document.ExpiryDate < DateTime.Today.AddDays(30);

                    <MudListItem T="EmployeeDocumentResponse">
                        <MudStack Spacing="1" Class="full-width">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Spacing="0">
                                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                        <MudIcon Icon="@GetDocumentIcon(document.DocumentType ?? "other")" Size="Size.Small" />
                                        <MudText Typo="Typo.body2">
                                            <strong>@document.Title</strong>
                                        </MudText>
                                        @if (isExpired)
                                        {
                                            <MudChip Size="Size.Small" Color="Color.Error" Text="Expired" />
                                        }
                                        else if (isExpiringSoon)
                                        {
                                            <MudChip Size="Size.Small" Color="Color.Warning" Text="Expiring Soon" />
                                        }
                                    </MudStack>
                                    <MudText Typo="Typo.caption" Class="ml-7">@document.DocumentType</MudText>
                                </MudStack>
                                <MudStack Row="true" Spacing="1">
                                    @if (!string.IsNullOrWhiteSpace(document.FilePath))
                                    {
                                        <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Info" OnClick="@(() => DownloadDocument(document))">
                                            Download
                                        </MudButton>
                                    }
                                    <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => EditDocument(document))">
                                        Edit
                                    </MudButton>
                                    <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Error" OnClick="@(() => DeleteDocument(document.Id))">
                                        Delete
                                    </MudButton>
                                </MudStack>
                            </MudStack>

                            <MudStack Spacing="0" Class="mt-2 ml-7">
                                @if (!string.IsNullOrWhiteSpace(document.FileName))
                                {
                                    <MudText Typo="Typo.caption">
                                        <MudIcon Size="Size.Small" Icon="@Icons.Material.Filled.AttachFile" Class="mr-1" />
                                        File: @document.FileName
                                        @if (document.FileSize.HasValue)
                                        {
                                            <span>(@FormatFileSize(document.FileSize.Value))</span>
                                        }
                                    </MudText>
                                }
                                @if (!string.IsNullOrWhiteSpace(document.IssueNumber))
                                {
                                    <MudText Typo="Typo.caption">
                                        <MudIcon Size="Size.Small" Icon="@Icons.Material.Filled.Tag" Class="mr-1" />
                                        Issue #: @document.IssueNumber
                                    </MudText>
                                }
                                @if (document.IssueDate.HasValue)
                                {
                                    <MudText Typo="Typo.caption">
                                        <MudIcon Size="Size.Small" Icon="@Icons.Material.Filled.CalendarToday" Class="mr-1" />
                                        Issue Date: @document.IssueDate.Value.ToString("MMM dd, yyyy")
                                    </MudText>
                                }
                                @if (document.ExpiryDate.HasValue)
                                {
                                    <MudText Typo="Typo.caption" Color="@(isExpired ? Color.Error : isExpiringSoon ? Color.Warning : Color.Default)">
                                        <MudIcon Size="Size.Small" Icon="@Icons.Material.Filled.EventBusy" Class="mr-1" />
                                        Expiry Date: @document.ExpiryDate.Value.ToString("MMM dd, yyyy")
                                        @if (document.ExpiryDate.HasValue)
                                        {
                                            var days = (document.ExpiryDate.Value.Date - DateTime.Today).Days;
                                            if (days < 0)
                                            {
                                                <span>(Expired @Math.Abs(days) days ago)</span>
                                            }
                                            else if (days <= 30)
                                            {
                                                <span>(Expires in @days days)</span>
                                            }
                                        }
                                    </MudText>
                                }
                                @if (!string.IsNullOrWhiteSpace(document.Notes))
                                {
                                    <MudText Typo="Typo.caption">
                                        <MudIcon Size="Size.Small" Icon="@Icons.Material.Filled.Note" Class="mr-1" />
                                        @document.Notes
                                    </MudText>
                                }
                            </MudStack>
                        </MudStack>
                    </MudListItem>
                    <MudDivider />
                }
            </MudList>
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter]
    public DefaultIdType EmployeeId { get; set; }

    

    private List<EmployeeDocumentResponse> _documents = new();
    private bool _loading;
    private ClientPreference _preference = new();

    protected override async Task OnInitializedAsync()
    {
        // Load preference
        if (await ClientPreferences.GetPreference() is ClientPreference preference)
        {
            _preference = preference;
        }

        // Subscribe to preference changes
        Courier.SubscribeWeak<NotificationWrapper<ClientPreference>>(wrapper =>
        {
            _preference.Elevation = ClientPreference.SetClientPreference(wrapper.Notification);
            StateHasChanged();
            return Task.CompletedTask;
        });

        await LoadDocuments();
    }

    private async Task LoadDocuments()
    {
        try
        {
            var request = new SearchEmployeeDocumentsRequest
            {
                PageNumber = 1,
                PageSize = 100
            };
            var result = await Client.SearchEmployeeDocumentsEndpointAsync("1", request);
            _documents = result?.Items?.Where(d => d.EmployeeId == EmployeeId).ToList() ?? [];
        }
        catch (Exception ex)
        {
            Snackbar?.Add($"Error loading documents: {ex.Message}", Severity.Error);
        }
    }

    private async Task AddDocument()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<EmployeeDocumentDialog>(
            "Upload Document",
            new DialogParameters { { "EmployeeId", EmployeeId }, { "IsCreate", true } },
            options);

        var result = await dialog.Result;
        if (result is { Canceled: false })
        {
            await LoadDocuments();
        }
    }

    private async Task EditDocument(EmployeeDocumentResponse document)
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<EmployeeDocumentDialog>(
            "Edit Document",
            new DialogParameters { { "EmployeeId", EmployeeId }, { "IsCreate", false }, { "ExistingDocument", document } },
            options);

        var result = await dialog.Result;
        if (result is { Canceled: false })
        {
            await LoadDocuments();
        }
    }

    private async Task DeleteDocument(DefaultIdType documentId)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Delete Document",
            "Are you sure you want to delete this document? This action cannot be undone.",
            "Delete",
            "Cancel");

        if (confirmed == true)
        {
            try
            {
                await Client.DeleteEmployeeDocumentEndpointAsync("1", documentId);
                Snackbar?.Add("Document deleted successfully", Severity.Success);
                await LoadDocuments();
            }
            catch (Exception ex)
            {
                Snackbar?.Add($"Error deleting document: {ex.Message}", Severity.Error);
            }
        }
    }

    private void DownloadDocument(EmployeeDocumentResponse document)
    {
        try
        {
            // TODO: Implement file download when API supports it
            Snackbar?.Add("Download functionality coming soon", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar?.Add($"Error downloading document: {ex.Message}", Severity.Error);
        }
    }

    private string GetDocumentIcon(string? documentType)
    {
        return (documentType ?? "other").ToLower() switch
        {
            "contract" => Icons.Material.Filled.Description,
            "certification" => Icons.Material.Filled.EmojiEvents,
            "license" => Icons.Material.Filled.CardMembership,
            "identity" => Icons.Material.Filled.Badge,
            "medical" => Icons.Material.Filled.LocalHospital,
            _ => Icons.Material.Filled.InsertDriveFile
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}

