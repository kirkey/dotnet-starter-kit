@page "/hr/employee-bank-accounts"
@namespace FSH.Starter.Blazor.Client.Pages.Hr.Employees.BankAccounts
@using FSH.Starter.Blazor.Client.Components.Hr

<PageHeader Title="@($"Bank Accounts{FilterSuffix}")" Header="Bank Accounts" SubHeader="Manage employee bank details for payroll routing and direct deposit." />

@if (!string.IsNullOrEmpty(FilterEmployeeId))
{
    <MudAlert Severity="Severity.Info" Class="mb-4">
        Viewing bank accounts for Employee ID: <strong>@FilterEmployeeId</strong>
        <MudButton Size="Size.Small" Variant="Variant.Text" OnClick="ClearFilter" Class="float-right">Clear Filter</MudButton>
    </MudAlert>
}

<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap" AlignItems="AlignItems.Center">
        <MudSpacer />
        <MudButtonGroup Color="Color.Info" Variant="Variant.Outlined" Size="Size.Small">
            <MudButton StartIcon="@Icons.Material.Filled.Help" OnClick="@ShowBankAccountsHelp">
                Help
            </MudButton>
        </MudButtonGroup>
    </MudStack>
</MudPaper>

<EntityTable @ref="_table" TEntity="BankAccountResponse" TId="DefaultIdType" TRequest="BankAccountViewModel" Context="@Context">
    
    <ExtraActions Context="account">
        @if (account.Id != DefaultIdType.Empty)
        {
            <MudMenuItem OnClick="@(() => OnSetPrimary(account.Id))" Disabled="@account.IsPrimary">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="me-2" />
                Set as Primary
            </MudMenuItem>
            
            @if (!account.IsVerified)
            {
                <MudMenuItem OnClick="@(() => OnVerifyAccount(account.Id))">
                    <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Class="me-2" />
                    Verify Account
                </MudMenuItem>
            }
            else
            {
                <MudMenuItem OnClick="@(() => OnUnverifyAccount(account.Id))">
                    <MudIcon Icon="@Icons.Material.Filled.HighlightOff" Class="me-2" />
                    Unverify Account
                </MudMenuItem>
            }
            
            @if (account.IsActive)
            {
                <MudMenuItem OnClick="@(() => OnDeactivateAccount(account.Id))">
                    <MudIcon Icon="@Icons.Material.Filled.Lock" Class="me-2" />
                    Deactivate
                </MudMenuItem>
            }
            else
            {
                <MudMenuItem OnClick="@(() => OnActivateAccount(account.Id))">
                    <MudIcon Icon="@Icons.Material.Filled.LockOpen" Class="me-2" />
                    Activate
                </MudMenuItem>
            }
        }
    </ExtraActions>

    <EditFormContent Context="context">
        @if (!Context.AddEditModal.IsCreate)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudTextField Value="context.Id" Underline="false" ReadOnly Label="Account ID" />
            </MudItem>
        }

        <MudDivider DividerType="DividerType.FullWidth" Class="my-4" />

        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" GutterBottom="true">Employee & Bank Information</MudText>
        </MudItem>

        <MudItem xs="12" sm="6" md="6">
            <AutocompleteEmployee @bind-Value="context.SelectedEmployee"
                                   Label="Employee"
                                   Required="true"
                                   RequiredError="Employee is required"
                                   Variant="Variant.Filled"
                                   HelperText="Search and select employee"
                                   Disabled="@(!Context.AddEditModal.IsCreate)" />
        </MudItem>

        <MudItem xs="12" sm="6" md="6">
            <MudTextField @bind-Value="context.BankName"
                          For="@(() => context.BankName)"
                          Label="Bank Name"
                          Variant="Variant.Filled"
                          Required="true"
                          HelperText="E.g., BDO, BPI, Metrobank" />
        </MudItem>

        <MudItem xs="12" sm="6" md="6">
            <MudTextField @bind-Value="context.AccountHolderName"
                          For="@(() => context.AccountHolderName)"
                          Label="Account Holder Name"
                          Variant="Variant.Filled"
                          Required="true"
                          HelperText="Name on the bank account" />
        </MudItem>

        <MudItem xs="12" sm="6" md="6">
            <MudSelect @bind-Value="context.AccountType"
                       For="@(() => context.AccountType)"
                       Label="Account Type"
                       Required="true"
                       Variant="Variant.Filled">
                <MudSelectItem Value="@("Checking")">Checking</MudSelectItem>
                <MudSelectItem Value="@("Savings")">Savings</MudSelectItem>
                <MudSelectItem Value="@("Money Market")">Money Market</MudSelectItem>
                <MudSelectItem Value="@("Other")">Other</MudSelectItem>
            </MudSelect>
        </MudItem>

        <MudDivider DividerType="DividerType.FullWidth" Class="my-4" />

        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" GutterBottom="true">Account Details (Domestic - ACH)</MudText>
        </MudItem>

        <MudItem xs="12" sm="6" md="6">
            <MudTextField @bind-Value="context.AccountNumber"
                          For="@(() => context.AccountNumber)"
                          Label="Account Number"
                          Variant="Variant.Filled"
                          Required="true"
                          InputType="InputType.Password"
                          HelperText="Full account number (masked in display)" />
        </MudItem>

        <MudItem xs="12" sm="6" md="6">
            <MudTextField @bind-Value="context.RoutingNumber"
                          For="@(() => context.RoutingNumber)"
                          Label="Routing Number"
                          Variant="Variant.Filled"
                          Required="true"
                          HelperText="9-digit ACH/ABA routing number" />
        </MudItem>

        <MudItem xs="12" sm="6" md="6">
            <MudTextField @bind-Value="context.CurrencyCode"
                          For="@(() => context.CurrencyCode)"
                          Label="Currency Code"
                          Variant="Variant.Filled"
                          HelperText="E.g., USD, PHP. Default: USD"
                          Placeholder="USD" />
        </MudItem>

        <MudDivider DividerType="DividerType.FullWidth" Class="my-4" />

        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" GutterBottom="true">International Details (Optional - SWIFT/IBAN)</MudText>
        </MudItem>

        <MudItem xs="12" sm="6" md="6">
            <MudTextField @bind-Value="context.SwiftCode"
                          For="@(() => context.SwiftCode)"
                          Label="SWIFT Code"
                          Variant="Variant.Filled"
                          HelperText="International bank code (8-11 characters)" />
        </MudItem>

        <MudItem xs="12" sm="6" md="6">
            <MudTextField @bind-Value="context.Iban"
                          For="@(() => context.Iban)"
                          Label="IBAN"
                          Variant="Variant.Filled"
                          HelperText="International Bank Account Number" />
        </MudItem>

        <MudDivider DividerType="DividerType.FullWidth" Class="my-4" />

        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" GutterBottom="true">Account Status & Notes</MudText>
        </MudItem>

        <MudItem xs="12" sm="6" md="4">
            <MudCheckBox @bind-Value="context.IsPrimary"
                         Label="Primary Account"
                         Color="Color.Primary"
                         Class="mt-2"
                         HelperText="Use this as default for payroll deposits" />
        </MudItem>

        <MudItem xs="12" sm="6" md="4">
            <MudCheckBox @bind-Value="context.IsActive"
                         Label="Active"
                         Color="Color.Success"
                         Class="mt-2"
                         HelperText="Account is available for use" />
        </MudItem>

        <MudItem xs="12" sm="6" md="4">
            <MudCheckBox @bind-Value="context.IsVerified"
                         Label="Verified"
                         Color="Color.Info"
                         Class="mt-2"
                         HelperText="Account has been verified" />
        </MudItem>

        @if (context.IsVerified && context.VerificationDate.HasValue)
        {
            <MudItem xs="12" sm="6" md="6">
                <MudTextField Value="@context.VerificationDate?.ToString("MMMM dd, yyyy")" 
                              Underline="false" 
                              ReadOnly 
                              Label="Verification Date" />
            </MudItem>
        }

        <MudItem xs="12">
            <MudTextField @bind-Value="context.Notes"
                          For="@(() => context.Notes)"
                          Label="Notes"
                          Variant="Variant.Filled"
                          Lines="3"
                          HelperText="Additional account information or special instructions" />
        </MudItem>

        @* Display-only fields for existing records *@
        @if (!Context.AddEditModal.IsCreate)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudTextField Value="@context.Last4Digits" Underline="false" ReadOnly Label="Last 4 Digits" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudTextField Value="@context.EmployeeId" Underline="false" ReadOnly Label="Employee ID" />
            </MudItem>
        }

    </EditFormContent>
</EntityTable>
