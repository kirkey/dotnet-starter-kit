@namespace FSH.Starter.Blazor.Client.Pages.Accounting.BankReconciliations

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Reconciliation Summary</MudText>
    </TitleContent>
    <DialogContent>
        @if (Summary != null)
        {
            <MudStack Spacing="3">
                <MudPaper Elevation="0" Class="pa-3 mud-background-gray">
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="3">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Total Reconciliations</MudText>
                                <MudText Typo="Typo.h6">@Summary.TotalReconciliations</MudText>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Pending</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Default">@Summary.PendingCount</MudText>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">In Progress</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Info">@Summary.InProgressCount</MudText>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Approved</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Success">@Summary.ApprovedCount</MudText>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </MudPaper>

                <MudDivider />

                <MudText Typo="Typo.subtitle1">Recent Reconciliations</MudText>

                @if (Summary.RecentReconciliations.Any())
                {
                    <MudList T="string">
                        @foreach (var rec in Summary.RecentReconciliations)
                        {
                            <MudListItem T="string">
                                <MudStack Row="true" Spacing="2" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body2">@(rec.StatementNumber ?? "N/A")</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@rec.ReconciliationDate.ToString("MMMM dd, yyyy")</MudText>
                                    </MudStack>
                                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(rec.Status)" Variant="Variant.Filled">
                                            @rec.Status
                                        </MudChip>
                                        <MudText Typo="Typo.body2">@rec.AdjustedBalance.ToString("C")</MudText>
                                    </MudStack>
                                </MudStack>
                            </MudListItem>
                        }
                    </MudList>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No recent reconciliations found.</MudAlert>
                }

                <MudDivider />

                <MudText Typo="Typo.subtitle1">Bank Account Summary</MudText>

                @if (Summary.BankAccountSummaries.Any())
                {
                    <MudSimpleTable Striped="true" Bordered="true" Dense="true">
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th>Last Reconciliation</th>
                                <th>Balance</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var acct in Summary.BankAccountSummaries)
                            {
                                <tr>
                                    <td>@acct.AccountName</td>
                                    <td>@(acct.LastReconciliationDate?.ToString("MMMM dd, yyyy") ?? "Never")</td>
                                    <td>@acct.CurrentBalance.ToString("C")</td>
                                    <td>
                                        @if (acct.IsCurrentlyReconciled)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">Approved</MudChip>
                                        }
                                        else
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Filled">Pending</MudChip>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
            </MudStack>
        }
        else
        {
            <MudProgressCircular Indeterminate="true" />
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => Cancel())">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    private ReconciliationSummary? Summary { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadSummary();
    }

    private async Task LoadSummary()
    {
        try
        {
            // This would call an API endpoint to get summary data
            // For now, we'll create a mock summary
            Summary = new ReconciliationSummary();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading summary: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(string? status) => status switch
    {
        "Pending" => Color.Default,
        "InProgress" => Color.Info,
        "Completed" => Color.Warning,
        "Approved" => Color.Success,
        _ => Color.Default
    };

    private void Cancel() => MudDialog.Cancel();

    private class ReconciliationSummary
    {
        public int TotalReconciliations { get; set; }
        public int PendingCount { get; set; }
        public int InProgressCount { get; set; }
        public int ApprovedCount { get; set; }
        public List<BankReconciliationResponse> RecentReconciliations { get; set; } = [];
        public List<BankAccountSummaryItem> BankAccountSummaries { get; set; } = [];
    }

    private class BankAccountSummaryItem
    {
        public string AccountName { get; set; } = string.Empty;
        public DateTime? LastReconciliationDate { get; set; }
        public decimal CurrentBalance { get; set; }
        public bool IsCurrentlyReconciled { get; set; }
    }
}

