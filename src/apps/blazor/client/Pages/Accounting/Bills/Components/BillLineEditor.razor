@* 
    Bill Line Item Editor Component
    Provides inline editing of bill line items with real-time total calculation
    Similar to Journal Entry Line Editor pattern
*@

<MudTable Items="@Lines" Dense="true" Hover="true" Elevation="0" Class="mb-3">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Bill Line Items</MudText>
        <MudSpacer />
        <MudButton StartIcon="@Icons.Material.Filled.Add"
                   Color="Color.Primary"
                   Size="Size.Small"
                   OnClick="@(() => AddLine())"
                   Disabled="@IsReadOnly">
            Add Line Item
        </MudButton>
    </ToolBarContent>
    <HeaderContent>
        <MudTh Style="width:80px;">Line #</MudTh>
        <MudTh>Description</MudTh>
        <MudTh Style="width:250px;">Account</MudTh>
        <MudTh Style="text-align:right; width:120px;">Quantity</MudTh>
        <MudTh Style="text-align:right; width:120px;">Unit Price</MudTh>
        <MudTh Style="text-align:right; width:120px;">Amount</MudTh>
        <MudTh Style="text-align:right; width:120px;">Tax</MudTh>
        @if (!IsReadOnly)
        {
            <MudTh Style="width:80px;">Actions</MudTh>
        }
    </HeaderContent>
    <RowTemplate Context="line">
        <MudTd DataLabel="Line #">
            @if (IsReadOnly)
            {
                <span>@line.LineNumber</span>
            }
            else
            {
                <MudNumericField @bind-Value="line.LineNumber"
                                Variant="Variant.Outlined"
                                Margin="Margin.Dense"
                                Min="1"
                                HideSpinButtons="true" />
            }
        </MudTd>
        <MudTd DataLabel="Description">
            @if (IsReadOnly)
            {
                <span>@line.Description</span>
            }
            else
            {
                <MudTextField @bind-Value="line.Description"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             MaxLength="500"
                             Required="true" />
            }
        </MudTd>
        <MudTd DataLabel="Account">
            @if (IsReadOnly)
            {
                <span>@line.ChartOfAccountCode - @line.ChartOfAccountName</span>
            }
            else
            {
                <AutocompleteChartOfAccountId @bind-Value="line.ChartOfAccountId"
                                              For="@(()=>line.ChartOfAccountId)"
                                              Label=""
                                              Variant="Variant.Outlined"
                                              Margin="Margin.Dense"
                                              TextFormat="CodeName"
                                              Required="true" />
            }
        </MudTd>
        <MudTd DataLabel="Quantity" Style="text-align:right">
            @if (IsReadOnly)
            {
                <span>@line.Quantity.ToString("N4")</span>
            }
            else
            {
                <MudNumericField T="decimal"
                                Value="line.Quantity"
                                Format="N4"
                                Variant="Variant.Outlined"
                                Margin="Margin.Dense"
                                Min="0.0001m"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.Tag"
                                ValueChanged="@((decimal val) => { line.Quantity = val; line.CalculateAmount(); LinesChanged.InvokeAsync(Lines); })" />
            }
        </MudTd>
        <MudTd DataLabel="Unit Price" Style="text-align:right">
            @if (IsReadOnly)
            {
                <span>@line.UnitPrice.ToString("N2")</span>
            }
            else
            {
                <MudNumericField T="decimal"
                                Value="line.UnitPrice"
                                Format="N2"
                                Variant="Variant.Outlined"
                                Margin="Margin.Dense"
                                Min="0"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                                ValueChanged="@((decimal val) => { line.UnitPrice = val; line.CalculateAmount(); LinesChanged.InvokeAsync(Lines); })" />
            }
        </MudTd>
        <MudTd DataLabel="Amount" Style="text-align:right">
            <strong>@line.Amount.ToString("N2")</strong>
        </MudTd>
        <MudTd DataLabel="Tax" Style="text-align:right">
            @if (IsReadOnly)
            {
                <span>@line.TaxAmount.ToString("N2")</span>
            }
            else
            {
                <MudNumericField T="decimal"
                                Value="line.TaxAmount"
                                Format="N2"
                                Variant="Variant.Outlined"
                                Margin="Margin.Dense"
                                Min="0"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.Percent"
                                ValueChanged="@((decimal val) => { line.TaxAmount = val; LinesChanged.InvokeAsync(Lines); })" />
            }
        </MudTd>
        @if (!IsReadOnly)
        {
            <MudTd DataLabel="Actions">
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                              Color="Color.Error"
                              Size="Size.Small"
                              OnClick="@(() => RemoveLine(line))" />
            </MudTd>
        }
    </RowTemplate>
    <FooterContent>
        <MudTd colspan="5"><strong>TOTALS</strong></MudTd>
        <MudTd Style="text-align:right"><strong>@SubtotalAmount.ToString("N2")</strong></MudTd>
        <MudTd Style="text-align:right"><strong>@TotalTax.ToString("N2")</strong></MudTd>
        @if (!IsReadOnly)
        {
            <MudTd></MudTd>
        }
    </FooterContent>
</MudTable>

@if (Lines.Count == 0)
{
    <MudAlert Severity="Severity.Info" Dense="true">
        Click "Add Line Item" to start adding items to this bill. At least one line item is required.
    </MudAlert>
}
else if (!IsReadOnly)
{
    <MudAlert Severity="Severity.Success" Dense="true" Class="mt-2">
        <div class="d-flex justify-space-between align-center">
            <div>
                <strong>Line Items:</strong> @Lines.Count &nbsp;&nbsp;
                <strong>Subtotal:</strong> @SubtotalAmount.ToString("N2") &nbsp;&nbsp;
                <strong>Tax:</strong> @TotalTax.ToString("N2") &nbsp;&nbsp;
                <strong>Total Amount:</strong> @TotalAmount.ToString("N2")
            </div>
        </div>
    </MudAlert>
}

