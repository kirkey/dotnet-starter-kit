@using Accounting.Application.Payments.Get.v1

<MudDialog>
    <DialogContent>
        @if (_payment != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6">Payment Details</MudText>
                    <MudDivider Class="my-2" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField Value="@_payment.PaymentNumber"
                                  Label="Payment Number"
                                  ReadOnly
                                  Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField Value="@_payment.PaymentDate.ToString("MMMM dd, yyyy")"
                                  Label="Payment Date"
                                  ReadOnly
                                  Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField Value="@_payment.Amount"
                                     Label="Payment Amount"
                                     Format="C2"
                                     ReadOnly
                                     Variant="Variant.Outlined"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Filled.AttachMoney" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField Value="@_payment.UnappliedAmount"
                                     Label="Unapplied Amount"
                                     Format="C2"
                                     ReadOnly
                                     Variant="Variant.Outlined"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Filled.Money"
                                     Adornment="Adornment.Start"
                                     AdornmentColor="@(_payment.UnappliedAmount > 0 ? Color.Warning : Color.Success)" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField Value="@_payment.PaymentMethod"
                                  Label="Payment Method"
                                  ReadOnly
                                  Variant="Variant.Outlined" />
                </MudItem>

                @if (!string.IsNullOrEmpty(_payment.ReferenceNumber))
                {
                    <MudItem xs="12" sm="6">
                        <MudTextField Value="@_payment.ReferenceNumber"
                                      Label="Reference Number"
                                      ReadOnly
                                      Variant="Variant.Outlined" />
                    </MudItem>
                }

                @if (!string.IsNullOrEmpty(_payment.DepositToAccountCode))
                {
                    <MudItem xs="12" sm="6">
                        <MudTextField Value="@_payment.DepositToAccountCode"
                                      Label="Deposit Account"
                                      ReadOnly
                                      Variant="Variant.Outlined" />
                    </MudItem>
                }

                @if (!string.IsNullOrEmpty(_payment.Description))
                {
                    <MudItem xs="12">
                        <MudTextField Value="@_payment.Description"
                                      Label="Description"
                                      ReadOnly
                                      Variant="Variant.Outlined"
                                      Lines="2" />
                    </MudItem>
                }

                @if (!string.IsNullOrEmpty(_payment.Notes))
                {
                    <MudItem xs="12">
                        <MudTextField Value="@_payment.Notes"
                                      Label="Notes"
                                      ReadOnly
                                      Variant="Variant.Outlined"
                                      Lines="3" />
                    </MudItem>
                }

                @if (_payment.Allocations.Any())
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mt-4">Payment Allocations</MudText>
                        <MudDivider Class="my-2" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTable Items="@_payment.Allocations"
                                  Hover="true"
                                  Striped="true"
                                  Dense="true"
                                  Elevation="0">
                            <HeaderContent>
                                <MudTh>Invoice ID</MudTh>
                                <MudTh Style="text-align: right">Amount</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Invoice ID">@context.InvoiceId</MudTd>
                                <MudTd DataLabel="Amount" Style="text-align: right">@context.Amount.ToString("C2")</MudTd>
                            </RowTemplate>
                            <FooterContent>
                                <MudTh Style="font-weight: bold">Total Allocated</MudTh>
                                <MudTh Style="text-align: right; font-weight: bold">@_payment.Allocations.Sum(a => a.Amount).ToString("C2")</MudTh>
                            </FooterContent>
                        </MudTable>
                    </MudItem>
                }

                <MudItem xs="12" sm="6">
                    <MudTextField Value="@_payment.CreatedOn.ToString("MMMM dd, yyyy hh:mm tt")"
                                  Label="Created On"
                                  ReadOnly
                                  Variant="Variant.Outlined" />
                </MudItem>

                @if (_payment.LastModifiedOn.HasValue)
                {
                    <MudItem xs="12" sm="6">
                        <MudTextField Value="@_payment.LastModifiedOn.Value.ToString("MMMM dd, yyyy hh:mm tt")"
                                      Label="Last Modified"
                                      ReadOnly
                                      Variant="Variant.Outlined" />
                    </MudItem>
                }
            </MudGrid>
        }
        else if (_loading)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else
        {
            <MudText>Payment not found.</MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;

    [Inject] private IClient AccountingClient { get; set; } = default!;

    private PaymentGetResponse? _payment;
    private bool _loading = false;

    public async Task ShowAsync(DefaultIdType paymentId)
    {
        _loading = true;
        _payment = null;
        
        var dialogOptions = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        var dialog = DialogService.Show<PaymentDetailsDialog>("Payment Details", dialogOptions);
        
        StateHasChanged();

        _payment = await ApiHelper.ExecuteCallGuardedAsync(
            () => AccountingClient.GetPaymentAsync(paymentId),
            Snackbar);

        _loading = false;
        StateHasChanged();

        await dialog.Result;
    }

    private void Close() => MudDialog.Close();
}

