<MudDialog>
    <DialogContent>
        <MudContainer Style="max-height: 70vh; overflow-y: auto;">
            @if (_loading)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            }
            else
            {
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-4">Create Goods Receipt from Purchase Order</MudText>
                    </MudItem>

                    @if (_selectedPurchaseOrder == null)
                    {
                        <MudItem xs="12">
                            <MudText Typo="Typo.subtitle2" Class="mb-3">Step 1: Select Purchase Order</MudText>
                        </MudItem>

                        <MudItem xs="12">
                            <MudTable Items="@_purchaseOrders" Dense="true" Hover="true" Filter="new Func<PurchaseOrderResponse, bool>(FilterPurchaseOrders)">
                                <ToolBarContent>
                                    <MudTextField @bind-Value="_searchString" Placeholder="Search" Adornment="Adornment.Start" 
                                                 AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                                </ToolBarContent>
                                <HeaderContent>
                                    <MudTh>Order Number</MudTh>
                                    <MudTh>Supplier</MudTh>
                                    <MudTh>Order Date</MudTh>
                                    <MudTh>Status</MudTh>
                                    <MudTh Style="text-align: center;">Action</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Order Number">@context.OrderNumber</MudTd>
                                    <MudTd DataLabel="Supplier">@GetSupplierName(context.SupplierId)</MudTd>
                                    <MudTd DataLabel="Order Date">@context.OrderDate.ToString("MMM dd, yyyy")</MudTd>
                                    <MudTd DataLabel="Status">
                                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">@context.Status</MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Action" Style="text-align: center;">
                                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" OnClick="@(() => SelectPurchaseOrder(context))">
                                            Select
                                        </MudButton>
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        </MudItem>
                    }
                    else
                    {
                        <MudItem xs="12">
                            <MudText Typo="Typo.subtitle2" Class="mb-3">Step 2: Enter Receipt Details</MudText>
                        </MudItem>

                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Info" Dense="true">
                                Creating receipt for PO: <strong>@_selectedPurchaseOrder.OrderNumber</strong>
                            </MudAlert>
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_receiptNumber" Label="Receipt Number" Required="true" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudDatePicker @bind-Date="_receivedDate" Label="Received Date" DateFormat="MMMM dd, yyyy" Required="true" />
                        </MudItem>

                        <MudItem xs="12">
                            <AutocompleteWarehouse @bind-Value="_warehouseId" Label="Warehouse" Required="true" />
                        </MudItem>

                        <MudItem xs="12">
                            <MudTextField @bind-Value="_notes" Label="Notes" Lines="3" />
                        </MudItem>

                        <MudItem xs="12">
                            <MudDivider Class="my-3" />
                        </MudItem>

                        <MudItem xs="12">
                            <div class="d-flex justify-space-between align-center mb-3">
                                <MudText Typo="Typo.subtitle2">Items to Receive</MudText>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" OnClick="BackToPOSelection">
                                    Change PO
                                </MudButton>
                            </div>
                        </MudItem>

                        <MudItem xs="12">
                            @if (_poItems?.Any() == true)
                            {
                                <MudTable Items="@_poItems" Dense="true" Hover="true">
                                    <HeaderContent>
                                        <MudTh>
                                            <MudCheckBox T="bool" Checked="@_selectAll" CheckedChanged="@ToggleSelectAll" Color="Color.Primary" />
                                        </MudTh>
                                        <MudTh>Item</MudTh>
                                        <MudTh Style="text-align: right;">Ordered</MudTh>
                                        <MudTh Style="text-align: right;">Received</MudTh>
                                        <MudTh Style="text-align: right;">Remaining</MudTh>
                                        <MudTh Style="text-align: right;">Qty to Receive</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd>
                                            <MudCheckBox T="bool" Checked="@IsItemSelected(context.Id)" CheckedChanged="@((bool val) => ToggleItemSelection(context.Id, val))" Color="Color.Primary" />
                                        </MudTd>
                                        <MudTd DataLabel="Item">@context.ItemName</MudTd>
                                        <MudTd DataLabel="Ordered" Style="text-align: right;">@context.Quantity</MudTd>
                                        <MudTd DataLabel="Received" Style="text-align: right;">@context.ReceivedQuantity</MudTd>
                                        <MudTd DataLabel="Remaining" Style="text-align: right;">
                                            <strong>@(context.Quantity - context.ReceivedQuantity)</strong>
                                        </MudTd>
                                        <MudTd DataLabel="Qty to Receive" Style="text-align: right;">
                                            @if (IsItemSelected(context.Id))
                                            {
                                                <MudNumericField T="int" @bind-Value="@_receiveQuantities[context.Id]" 
                                                                Min="0" Max="@(context.Quantity - context.ReceivedQuantity)" 
                                                                Style="width: 100px;" />
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </MudTd>
                                    </RowTemplate>
                                </MudTable>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Warning">No items available for receiving.</MudAlert>
                            }
                        </MudItem>
                    }
                </MudGrid>
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => Cancel())">Cancel</MudButton>
        @if (_selectedPurchaseOrder != null)
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CreateReceipt" Disabled="@(!CanCreateReceipt())">
                Create Receipt
            </MudButton>
        }
    </DialogActions>
</MudDialog>
