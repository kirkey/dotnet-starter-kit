@page "/store/purchase-orders/items/{PurchaseOrderId:guid}"

<MudTable Items="@_items" Hover="true" Dense="true" Bordered="true" Striped="true" Loading="@_loading">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Order Items</MudText>
        <MudSpacer />
        <MudButton Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" OnClick="@OpenAddItemDialog">
            Add Item
        </MudButton>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Grocery Item</MudTh>
        <MudTh>Quantity</MudTh>
        <MudTh>Unit Price</MudTh>
        <MudTh>Discount</MudTh>
        <MudTh>Total Price</MudTh>
        <MudTh>Received Qty</MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Grocery Item">@context.GroceryItemName (@context.GroceryItemSku)</MudTd>
        <MudTd DataLabel="Quantity">@context.Quantity @context.Unit</MudTd>
        <MudTd DataLabel="Unit Price">@context.UnitPrice.ToString("C2")</MudTd>
        <MudTd DataLabel="Discount">@context.DiscountPercentage%</MudTd>
        <MudTd DataLabel="Total Price">@context.Total.ToString("C2")</MudTd>
        <MudTd DataLabel="Received Qty">N/A</MudTd>
        <MudTd DataLabel="Actions">
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => OpenEditItemDialog(context))" />
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => RemoveItem(context.Id))" />
        </MudTd>
    </RowTemplate>
    <NoRecordsContent>
        <MudText>No items added yet. Click "Add Item" to start.</MudText>
    </NoRecordsContent>
</MudTable>

@code {
    [Inject] private IClient ApiClient { get; set; } = default!;

    [Parameter] public DefaultIdType PurchaseOrderId { get; set; }

    private bool _loading;
    private List<PurchaseOrderItemModel> _items = new();

    protected override async Task OnParametersSetAsync()
    {
        if (PurchaseOrderId != default)
        {
            await LoadItemsAsync();
        }
    }

    private async Task LoadItemsAsync()
    {
        _loading = true;
        try
        {
            var response = await ApiClient.GetPurchaseOrderEndpointAsync("1", PurchaseOrderId).ConfigureAwait(false);
            // Note: The current API response doesn't include items
            // For now, we'll maintain a local list that gets updated through dialog operations
            // TODO: Update backend API to include items in the response or create a separate endpoint
            // _items will be populated when items are added/edited through the dialog
            
            // Clear the items list if this is a fresh load
            if (_items.Count == 0)
            {
                Toast.Add("Order loaded. Add items using the 'Add Item' button.", Severity.Info);
            }
        }
        catch (Exception ex)
        {
            Toast.Add($"Failed to load order: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenAddItemDialog()
    {
        var parameters = new DialogParameters
        {
            { "PurchaseOrderId", PurchaseOrderId },
            { "IsEdit", false }
        };

        var dialog = await DialogService.ShowAsync<PurchaseOrderItemDialog>("Add Order Item", parameters);
        if (dialog == null) return;
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: PurchaseOrderItemModel model })
        {
            // Add the new item to the local list
            _items.Add(model);
            StateHasChanged();
        }
    }

    private async Task OpenEditItemDialog(PurchaseOrderItemModel item)
    {
        var parameters = new DialogParameters
        {
            { "PurchaseOrderId", PurchaseOrderId },
            { "Item", item },
            { "IsEdit", true }
        };

        var dialog = await DialogService.ShowAsync<PurchaseOrderItemDialog>("Edit Order Item", parameters);
        if (dialog == null) return;
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: PurchaseOrderItemModel model })
        {
            // Update the item in the local list
            var existingItem = _items.FirstOrDefault(x => x.Id == item.Id);
            if (existingItem != null)
            {
                existingItem.Quantity = model.Quantity;
                existingItem.UnitPrice = model.UnitPrice;
                existingItem.DiscountPercentage = model.DiscountPercentage;
                StateHasChanged();
            }
        }
    }

    private async Task RemoveItem(DefaultIdType itemId)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Remove Item",
            "Are you sure you want to remove this item from the order?",
            yesText: "Remove", cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                var item = _items.FirstOrDefault(x => x.Id == itemId);
                if (item != null)
                {
                    await ApiClient.RemovePurchaseOrderItemEndpointAsync("1", PurchaseOrderId, item.GroceryItemId).ConfigureAwait(false);
                    _items.RemoveAll(x => x.Id == itemId);
                    Toast.Add("Item removed from the order", Severity.Success);
                }
            }
            catch (Exception ex)
            {
                Toast.Add($"Failed to remove item: {ex.Message}", Severity.Error);
            }
        }
    }
}
