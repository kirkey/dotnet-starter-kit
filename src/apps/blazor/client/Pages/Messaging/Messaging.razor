@page "/messaging"


<PageHeader Title="Messaging" Header="Messaging" SubHeader="Chat with your team members." />

<MudGrid>
    <!-- Conversations List -->
    <MudItem xs="12" md="3">
        <MudPaper Elevation="@_preference.Elevation" Class="pa-4" Style="height: calc(100vh - 200px); overflow-y: auto;">
            <MudStack Spacing="2">
                <!-- Header with New Chat Button -->
                <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                    <MudText Typo="Typo.h6">Conversations</MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Size="Size.Small" 
                                   OnClick="@OpenNewConversationDialog" Title="New Conversation" />
                </MudStack>
                
                <MudDivider />
                
                <!-- Search Conversations -->
                <MudTextField @bind-Value="_searchConversation" 
                              Placeholder="Search conversations..." 
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Variant="Variant.Outlined" 
                              Margin="Margin.Dense" />
                
                <!-- Conversations List -->
                @if (_conversations == null)
                {
                    <MudProgressCircular Indeterminate="true" />
                }
                else if (!_conversations.Any())
                {
                    <MudText Typo="Typo.body2" Color="Color.Default" Align="Align.Center" Class="mt-4">
                        No conversations yet. Start a new chat!
                    </MudText>
                }
                else
                {
                    @foreach (var conversation in FilteredConversations)
                    {
                        var selectedClass = IsSelectedConversation(conversation.Id) ? "conversation-card selected" : "conversation-card";
                        <MudCard Elevation="@_preference.Elevation" Class="@selectedClass"
                                 @onclick="@(() => SelectConversation(conversation))">
                            <MudCardContent Class="pa-2">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <MudAvatar Color="Color.Primary" Size="Size.Medium">
                                        @GetConversationInitials(conversation)
                                    </MudAvatar>
                                    <MudStack Spacing="0" Style="flex: 1;">
                                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.subtitle2">
                                                @GetConversationTitle(conversation)
                                            </MudText>
                                            @if (conversation.UnreadCount > 0)
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="Color.Error">@conversation.UnreadCount</MudChip>
                                            }
                                        </MudStack>
                                        <MudText Typo="Typo.caption" Color="Color.Default" Style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">
                                            @(conversation.LastMessageContent ?? "No messages yet")
                                        </MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Default">
                                            @FormatDateTime(conversation.LastMessageAt ?? conversation.CreatedOn)
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    }
                }
            </MudStack>
        </MudPaper>
    </MudItem>

    <!-- Chat Area -->
    <MudItem xs="12" md="6">
        @if (_selectedConversation == null)
        {
            <MudPaper Elevation="@_preference.Elevation" Class="pa-4 d-flex align-center justify-center" Style="height: calc(100vh - 200px);">
                <MudStack AlignItems="AlignItems.Center" Spacing="3">
                    <MudIcon Icon="@Icons.Material.Filled.ChatBubbleOutline" Size="Size.Large" Color="Color.Default" Style="font-size: 4rem;" />
                    <MudText Typo="Typo.h6" Color="Color.Default">Select a conversation to start messaging</MudText>
                </MudStack>
            </MudPaper>
        }
        else
        {
            <MudPaper Elevation="@_preference.Elevation" Style="height: calc(100vh - 200px); display: flex; flex-direction: column;">
                <!-- Chat Header -->
                <MudChatHeader>
                    <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="pa-3">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                            <MudAvatar Color="Color.Primary" Size="Size.Medium">
                                @GetConversationInitials(_selectedConversation)
                            </MudAvatar>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.subtitle1">
                                    @GetConversationTitle(_selectedConversation)
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Default">
                                    @GetMembersInfo(_selectedConversation)
                                </MudText>
                            </MudStack>
                        </MudStack>
                        <MudStack Row Spacing="1">
                            <MudIconButton Icon="@Icons.Material.Filled.Info" Color="Color.Default" Size="Size.Small"
                                           OnClick="@OpenConversationInfo" Title="Conversation Info" />
                            <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Color="Color.Default" Size="Size.Small"
                                           OnClick="@OpenConversationMenu" Title="More Options" />
                        </MudStack>
                    </MudStack>
                </MudChatHeader>

                <MudDivider />

                <!-- Messages Area -->
                <div id="chat-messages" class="chat-messages-container" style="flex: 1; overflow-y: auto; padding: 16px;">
                    @if (_messages == null)
                    {
                        <MudProgressCircular Indeterminate="true" Class="mx-auto" />
                    }
                    else if (!_messages.Any())
                    {
                        <MudText Typo="Typo.body2" Color="Color.Default" Align="Align.Center" Class="mt-4">
                            No messages yet. Start the conversation!
                        </MudText>
                    }
                    else
                    {
                        @foreach (var message in _messages)
                        {
                            var isCurrentUser = message.SenderId == _currentUserId;
                            <div class="message-wrapper" style="display: flex; justify-content: @(isCurrentUser ? "flex-end" : "flex-start"); margin-bottom: 12px;">
                                <MudChatBubble Position="@(isCurrentUser ? Position.End : Position.Start)"
                                               Color="@(isCurrentUser ? Color.Primary : Color.Default)"
                                               Elevation="@_preference.Elevation"
                                               Style="max-width: 70%; position: relative;">
                                    <MudStack Spacing="1">
                                        @if (!isCurrentUser)
                                        {
                                            <MudText Typo="Typo.caption" Color="Color.Primary" Style="font-weight: 600;">
                                                @GetSenderName(message.SenderId)
                                            </MudText>
                                        }
                                        <MudText Typo="Typo.body2" Style="word-wrap: break-word; white-space: pre-wrap;">
                                            @message.Content
                                        </MudText>
                                        @if (message.AttachmentCount > 0)
                                        {
                                            <MudChip T="object" Size="Size.Small" Icon="@Icons.Material.Filled.AttachFile" Color="Color.Info">
                                                @message.AttachmentCount @(message.AttachmentCount == 1 ? "file" : "files")
                                            </MudChip>
                                        }
                                        <MudStack Row Spacing="1" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                            <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                                                <MudText Typo="Typo.caption" Color="Color.Default" Style="font-size: 0.7rem;">
                                                    @FormatDateTime(message.SentAt)
                                                </MudText>
                                                @if (message.IsEdited)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Default" Style="height: 20px;">
                                                        edited
                                                    </MudChip>
                                                }
                                            </MudStack>
                                            @if (isCurrentUser)
                                            {
                                                <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true" 
                                                         AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                                                    <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => EditMessage(message))">
                                                        Edit Message
                                                    </MudMenuItem>
                                                    <MudMenuItem Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteMessage(message))">
                                                        <MudText Color="Color.Error">Delete Message</MudText>
                                                    </MudMenuItem>
                                                </MudMenu>
                                            }
                                        </MudStack>
                                    </MudStack>
                                </MudChatBubble>
                            </div>
                        }
                    }
                    <div @ref="_messagesEndRef"></div>
                </div>

                <MudDivider />

                <!-- Chat Footer -->
                <MudChatFooter>
                    <MudStack Class="pa-3" Spacing="2">
                        @if (_replyToMessage != null)
                        {
                            <MudPaper Class="pa-2" Elevation="0" Style="background-color: var(--mud-palette-background-grey);">
                                <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.caption" Color="Color.Primary">Replying to</MudText>
                                        <MudText Typo="Typo.body2" Style="font-style: italic;">@_replyToMessage.Content</MudText>
                                    </MudStack>
                                    <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" 
                                                   OnClick="@(() => _replyToMessage = null)" />
                                </MudStack>
                            </MudPaper>
                        }
                        <MudStack Row Spacing="2" AlignItems="AlignItems.End">
                            <MudIconButton Icon="@Icons.Material.Filled.AttachFile" Color="Color.Default" 
                                           OnClick="@OpenFileUpload" Title="Attach File" />
                            <MudTextField @bind-Value="_newMessage" 
                                          Placeholder="Type a message..." 
                                          Variant="Variant.Outlined"
                                          Lines="1"
                                          MaxLines="5"
                                          AutoGrow
                                          Class="flex-grow-1"
                                          OnKeyDown="@HandleKeyDown" />
                            <MudIconButton Icon="@Icons.Material.Filled.Send" Color="Color.Primary" 
                                           OnClick="@SendMessage" Disabled="@string.IsNullOrWhiteSpace(_newMessage)" 
                                           Title="Send Message" />
                        </MudStack>
                    </MudStack>
                </MudChatFooter>
            </MudPaper>
        }
    </MudItem>

    <!-- Members/Online Users Panel -->
    <MudItem xs="12" md="3">
        <MudPaper Elevation="@_preference.Elevation" Class="pa-4" Style="height: calc(100vh - 200px); overflow-y: auto;">
            <MudStack Spacing="2">
                <MudText Typo="Typo.h6">
                    @(_selectedConversation != null ? "Members" : "Online Users")
                </MudText>
                <MudDivider />
                
                @if (_selectedConversation != null)
                {
                    <!-- Conversation Members -->
                    @if (_conversationDetails?.Members != null)
                    {
                        @foreach (var member in _conversationDetails.Members.Where(m => m.IsActive))
                        {
                            <MudCard Elevation="@_preference.Elevation" Class="pa-2">
                                <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                        <MudBadge Color="@(IsUserOnline(member.UserId) ? Color.Success : Color.Default)" 
                                                  Overlap="true" Dot="true">
                                            <MudAvatar Color="Color.Secondary" Size="Size.Small">
                                                @GetUserInitials(member.UserId)
                                            </MudAvatar>
                                        </MudBadge>
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body2">@GetUserName(member.UserId)</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Default">@member.Role</MudText>
                                        </MudStack>
                                    </MudStack>
                                    @if (IsCurrentUserAdmin() && member.UserId != _currentUserId)
                                    {
                                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                                            <MudMenuItem OnClick="@(() => ToggleMemberRole(member))">
                                                @(member.Role == "admin" ? "Remove Admin" : "Make Admin")
                                            </MudMenuItem>
                                            <MudMenuItem OnClick="@(() => RemoveMember(member))">
                                                Remove from conversation
                                            </MudMenuItem>
                                        </MudMenu>
                                    }
                                </MudStack>
                            </MudCard>
                        }
                        
                        @if (IsCurrentUserAdmin())
                        {
                            <MudButton StartIcon="@Icons.Material.Filled.PersonAdd" 
                                       Variant="Variant.Outlined" 
                                       Color="Color.Primary"
                                       FullWidth
                                       OnClick="@OpenAddMemberDialog">
                                Add Member
                            </MudButton>
                        }
                    }
                }
                else
                {
                    <!-- All Users List with Online/Offline Status -->
                    @if (_allUsers != null)
                    {
                        @foreach (var user in _allUsers)
                        {
                            var isOnline = _onlineUserIds.Contains(user.Id.ToString());
                            <MudCard Elevation="@_preference.Elevation" Class="pa-2 cursor-pointer" @onclick="@(() => StartDirectConversation(user))">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <MudBadge Color="@(isOnline ? Color.Success : Color.Default)" Overlap="true" Dot="true">
                                        <MudAvatar Color="Color.Secondary" Size="Size.Small">
                                            @GetUserInitials(user.Id)
                                        </MudAvatar>
                                    </MudBadge>
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body2">@user.Name</MudText>
                                        <MudText Typo="Typo.caption" Color="@(isOnline ? Color.Success : Color.Default)">
                                            @(isOnline ? "Online" : "Offline")
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudCard>
                        }
                    }
                }
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

<style>
    .conversation-card {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .conversation-card:hover {
        background-color: var(--mud-palette-action-default-hover);
        transform: translateX(4px);
    }
    
    .conversation-card.selected {
        background-color: var(--mud-palette-primary-lighten);
        border-left: 4px solid var(--mud-palette-primary);
    }
    
    .chat-messages-container {
        background-color: var(--mud-palette-background-grey);
    }
    
    .cursor-pointer {
        cursor: pointer;
    }
    
    .mud-chat-bubble {
        max-width: 70%;
        transition: all 0.2s ease;
    }
    
    .message-wrapper:hover .mud-chat-bubble {
        box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }
    
    .message-wrapper {
        animation: slideIn 0.3s ease-out;
    }
    
    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

