@namespace FSH.Starter.Blazor.Client.Pages.MicroFinance.ShareAccounts

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.h6">@TransactionType Shares</MudText>
            <MudText Typo="Typo.body2">Account: @Account.AccountNumber (@Account.MemberName)</MudText>
            
            <MudDivider />

            <MudAlert Severity="Severity.Info" Dense="true">
                Current Holdings: <strong>@Account.NumberOfShares shares</strong> worth <strong>@Account.TotalShareValue.ToString("N2")</strong>
            </MudAlert>

            @if (TransactionType == "Purchase")
            {
                <MudNumericField T="int"
                                 @bind-Value="_sharesToTransact"
                                 Label="Shares to Purchase"
                                 Variant="Variant.Filled"
                                 Min="1"
                                 HelperText="Enter the number of shares to purchase" />
                
                <MudText Typo="Typo.body2">
                    Estimated Cost: <strong>@((_sharesToTransact * (Account.CurrentPrice ?? 0)).ToString("N2"))</strong>
                </MudText>
            }
            else if (TransactionType == "Redeem")
            {
                <MudNumericField T="int"
                                 @bind-Value="_sharesToTransact"
                                 Label="Shares to Redeem"
                                 Variant="Variant.Filled"
                                 Min="1"
                                 Max="@Account.NumberOfShares"
                                 HelperText="Enter the number of shares to redeem" />
                
                <MudText Typo="Typo.body2">
                    Estimated Payout: <strong>@((_sharesToTransact * (Account.CurrentPrice ?? 0)).ToString("N2"))</strong>
                </MudText>

                <MudAlert Severity="Severity.Warning" Dense="true">
                    You cannot redeem below the minimum required shares for membership.
                </MudAlert>
            }
            else if (TransactionType == "Transfer")
            {
                <MudNumericField T="int"
                                 @bind-Value="_sharesToTransact"
                                 Label="Shares to Transfer"
                                 Variant="Variant.Filled"
                                 Min="1"
                                 Max="@Account.NumberOfShares"
                                 HelperText="Enter the number of shares to transfer" />
                
                <MudAutocomplete T="MemberResponse"
                                 Label="Transfer To Member"
                                 @bind-Value="_targetMember"
                                 SearchFunc="SearchMembers"
                                 ToStringFunc="@(m => m != null ? $"{m.FirstName} {m.LastName} ({m.MemberNumber})" : string.Empty)"
                                 Variant="Variant.Filled"
                                 Required="true"
                                 Dense="true"
                                 ShowProgressIndicator="true" />
            }

            <MudTextField @bind-Value="_notes"
                          Label="Transaction Notes"
                          Variant="Variant.Filled"
                          Lines="2" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit" Disabled="@(!IsValid)">
            @TransactionType
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public ShareAccountResponse Account { get; set; } = null!;

    [Parameter]
    public string TransactionType { get; set; } = "Purchase";

    [Inject]
    private IMicroFinanceClient Client { get; set; } = null!;

    [Inject]
    private ISnackbar Toast { get; set; } = null!;

    private int _sharesToTransact = 1;
    private string? _notes;
    private MemberResponse? _targetMember;

    private bool IsValid => TransactionType switch
    {
        "Purchase" => _sharesToTransact > 0,
        "Redeem" => _sharesToTransact > 0 && _sharesToTransact <= Account.NumberOfShares,
        "Transfer" => _sharesToTransact > 0 && _sharesToTransact <= Account.NumberOfShares && _targetMember != null,
        _ => false
    };

    private async Task<IEnumerable<MemberResponse>> SearchMembers(string searchText, CancellationToken ct)
    {
        var request = new SearchMembersCommand { PageNumber = 1, PageSize = 10, Keyword = searchText };
        var result = await Client.SearchMembersAsync("1", request).ConfigureAwait(false);
        return result.Data ?? Enumerable.Empty<MemberResponse>();
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Submit()
    {
        try
        {
            // Transaction logic would go here
            // For now, just close the dialog with success
            Toast.Add($"{TransactionType} of {_sharesToTransact} shares submitted successfully.", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Toast.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
}
