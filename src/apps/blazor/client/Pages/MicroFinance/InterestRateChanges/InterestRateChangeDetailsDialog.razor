@namespace FSH.Starter.Blazor.Client.Pages.MicroFinance.InterestRateChanges
@using FSH.Starter.Blazor.Infrastructure.Api

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Class="mr-3" />Interest Rate Change Details
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (RateChange != null)
        {
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Default">Reference</MudText>
                    <MudText Typo="Typo.body1">@(RateChange.Reference ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Default">Status</MudText>
                    <MudChip T="string" Color="@GetStatusColor(RateChange.Status)" Size="Size.Small">@RateChange.Status</MudChip>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Default">Loan ID</MudText>
                    <MudText Typo="Typo.body1">@RateChange.LoanId</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Default">Change Type</MudText>
                    <MudText Typo="Typo.body1">@(RateChange.ChangeType ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Default">Request Date</MudText>
                    <MudText Typo="Typo.body1">@RateChange.RequestDate.ToString("d")</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Default">Effective Date</MudText>
                    <MudText Typo="Typo.body1">@RateChange.EffectiveDate.ToString("d")</MudText>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudText Typo="Typo.caption" Color="Color.Default">Previous Rate</MudText>
                    <MudText Typo="Typo.body1">@RateChange.PreviousRate.ToString("N2")%</MudText>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudText Typo="Typo.caption" Color="Color.Default">New Rate</MudText>
                    <MudText Typo="Typo.body1" Color="@GetRateChangeColor()">@RateChange.NewRate.ToString("N2")%</MudText>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudText Typo="Typo.caption" Color="Color.Default">Rate Change</MudText>
                    <MudText Typo="Typo.body1" Color="@GetRateChangeColor()">
                        @GetRateChangePrefix()@((RateChange.NewRate - RateChange.PreviousRate).ToString("N2"))%
                    </MudText>
                </MudItem>
                <MudItem xs="12">
                    <MudText Typo="Typo.caption" Color="Color.Default">Change Reason</MudText>
                    <MudText Typo="Typo.body1">@(RateChange.ChangeReason ?? "N/A")</MudText>
                </MudItem>
                @if (!string.IsNullOrEmpty(RateChange.Notes))
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.caption" Color="Color.Default">Notes</MudText>
                        <MudText Typo="Typo.body1">@RateChange.Notes</MudText>
                    </MudItem>
                }
                @if (RateChange.Status == "Approved" || RateChange.Status == "Applied")
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle2" Color="Color.Success">Approval Information</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Default">Approved By</MudText>
                        <MudText Typo="Typo.body1">@(RateChange.ApprovedBy ?? "N/A")</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Default">Approved Date</MudText>
                        <MudText Typo="Typo.body1">@(RateChange.ApprovedDate?.ToString("g") ?? "N/A")</MudText>
                    </MudItem>
                }
                @if (RateChange.Status == "Applied")
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary">Application Information</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Default">Applied Date</MudText>
                        <MudText Typo="Typo.body1">@(RateChange.AppliedDate?.ToString("g") ?? "N/A")</MudText>
                    </MudItem>
                }
                @if (RateChange.Status == "Rejected")
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle2" Color="Color.Error">Rejection Information</MudText>
                    </MudItem>
                    <MudItem xs="12">
                        <MudText Typo="Typo.caption" Color="Color.Default">Rejection Reason</MudText>
                        <MudText Typo="Typo.body1">@(RateChange.RejectionReason ?? "N/A")</MudText>
                    </MudItem>
                }
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Default" OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public InterestRateChangeResponse? RateChange { get; set; }

    private void Close() => MudDialog.Close();

    private static Color GetStatusColor(string? status) => status switch
    {
        "Pending" => Color.Warning,
        "Approved" => Color.Info,
        "Applied" => Color.Success,
        "Rejected" => Color.Error,
        "Cancelled" => Color.Default,
        _ => Color.Default
    };

    private Color GetRateChangeColor()
    {
        if (RateChange == null) return Color.Default;
        var change = RateChange.NewRate - RateChange.PreviousRate;
        return change > 0 ? Color.Error : change < 0 ? Color.Success : Color.Default;
    }

    private string GetRateChangePrefix()
    {
        if (RateChange == null) return "";
        var change = RateChange.NewRate - RateChange.PreviousRate;
        return change > 0 ? "+" : "";
    }
}
