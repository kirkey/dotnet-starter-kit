@namespace FSH.Starter.Blazor.Client.Pages.MicroFinance.SavingsAccounts

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-height: 70vh; overflow-y: auto;">
            @if (_loading)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            }
            else if (_account != null)
            {
                <MudGrid>
                    <MudItem xs="12">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Savings" Size="Size.Large" Color="Color.Primary" />
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.h5">@_account.AccountNumber</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@_account.MemberName</MudText>
                            </MudStack>
                            <MudSpacer />
                            <MudChip T="string" Color="@GetStatusColor(_account.Status)" Size="Size.Medium">
                                @_account.Status
                            </MudChip>
                        </MudStack>
                    </MudItem>

                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudGrid>
                            <MudItem xs="6" sm="3">
                                <MudPaper Class="pa-3 text-center" Elevation="1">
                                    <MudText Typo="Typo.caption">Current Balance</MudText>
                                    <MudText Typo="Typo.h5" Color="Color.Primary">@_account.Balance.ToString("C2")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudPaper Class="pa-3 text-center" Elevation="1">
                                    <MudText Typo="Typo.caption">Total Deposits</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Success">@_account.TotalDeposits.ToString("C2")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudPaper Class="pa-3 text-center" Elevation="1">
                                    <MudText Typo="Typo.caption">Total Withdrawals</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Warning">@_account.TotalWithdrawals.ToString("C2")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudPaper Class="pa-3 text-center" Elevation="1">
                                    <MudText Typo="Typo.caption">Interest Earned</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Info">@_account.TotalInterestEarned.ToString("C2")</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.subtitle2" Class="mb-2 mt-3"><strong>Account Information</strong></MudText>
                        <MudSimpleTable Dense="true" Style="margin-bottom: 1rem;">
                            <tbody>
                                <tr>
                                    <td style="width: 45%; font-weight: 500;">Product</td>
                                    <td>@_account.ProductName</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 500;">Opened Date</td>
                                    <td>@_account.OpenedDate.ToString("MMMM dd, yyyy")</td>
                                </tr>
                                @if (_account.ClosedDate.HasValue)
                                {
                                    <tr>
                                        <td style="font-weight: 500;">Closed Date</td>
                                        <td>@_account.ClosedDate.Value.ToString("MMMM dd, yyyy")</td>
                                    </tr>
                                }
                                @if (_account.LastInterestPostingDate.HasValue)
                                {
                                    <tr>
                                        <td style="font-weight: 500;">Last Interest Posting</td>
                                        <td>@_account.LastInterestPostingDate.Value.ToString("MMMM dd, yyyy")</td>
                                    </tr>
                                }
                            </tbody>
                        </MudSimpleTable>
                    </MudItem>

                    @if (!string.IsNullOrEmpty(_account.Notes))
                    {
                        <MudItem xs="12">
                            <MudText Typo="Typo.subtitle2" Class="mb-2"><strong>Notes</strong></MudText>
                            <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-background-gray);">
                                <MudText Typo="Typo.body2">@_account.Notes</MudText>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
            }
            else
            {
                <MudAlert Severity="Severity.Error">Account not found.</MudAlert>
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Close" Color="Color.Primary" Variant="Variant.Filled">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public DefaultIdType AccountId { get; set; }

    private SavingsAccountResponse? _account;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadAccount();
    }

    private async Task LoadAccount()
    {
        _loading = true;
        try
        {
            _account = await ApiHelper.ExecuteCallGuardedAsync(
                () => Client.GetSavingsAccountAsync("1", AccountId),
                Snackbar);
        }
        finally
        {
            _loading = false;
        }
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Active" => Color.Success,
        "Dormant" => Color.Warning,
        "Frozen" => Color.Error,
        "Closed" => Color.Default,
        _ => Color.Default
    };

    private void Close() => MudDialog.Close();
}
