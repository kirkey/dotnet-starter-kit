<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.GroupWork" Class="mr-2" />
            Guarantor Details
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Primary">Guarantor Name</MudText>
                <MudText>@Guarantor.GuarantorName</MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Primary">Member Number</MudText>
                <MudText>@Guarantor.MemberNumber</MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Primary">Relationship</MudText>
                <MudText>@(Guarantor.Relationship ?? "Not Specified")</MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Primary">Status</MudText>
                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(Guarantor.Status)">@Guarantor.Status</MudChip>
            </MudItem>
            <MudItem xs="12">
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Loan Information</MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Primary">Loan Number</MudText>
                <MudText>@Guarantor.LoanNumber</MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Primary">Loan Amount</MudText>
                <MudText>KES @Guarantor.LoanAmount?.ToString("N0")</MudText>
            </MudItem>
            <MudItem xs="12">
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Guarantee Details</MudText>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudText Typo="Typo.caption" Color="Color.Primary">Guaranteed Amount</MudText>
                <MudText Typo="Typo.h6" Color="Color.Success">KES @Guarantor.GuaranteedAmount.ToString("N0")</MudText>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudText Typo="Typo.caption" Color="Color.Primary">Guarantee Date</MudText>
                <MudText>@Guarantor.GuaranteeDate?.ToString("dd/MM/yyyy")</MudText>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudText Typo="Typo.caption" Color="Color.Primary">Expiry Date</MudText>
                <MudText Color="@(IsExpiringSoon ? Color.Warning : Color.Default)">
                    @Guarantor.ExpiryDate?.ToString("dd/MM/yyyy")
                </MudText>
            </MudItem>
            @if (Guarantor.Status == "Approved")
            {
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Primary">Approved By</MudText>
                    <MudText>@Guarantor.ApprovedBy</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Primary">Approved At</MudText>
                    <MudText>@Guarantor.ApprovedAt?.ToString("dd/MM/yyyy HH:mm")</MudText>
                </MudItem>
            }
            @if (Guarantor.Status == "Rejected")
            {
                <MudItem xs="12">
                    <MudText Typo="Typo.caption" Color="Color.Error">Rejection Reason</MudText>
                    <MudText>@Guarantor.RejectionReason</MudText>
                </MudItem>
            }
            @if (!string.IsNullOrEmpty(Guarantor.Notes))
            {
                <MudItem xs="12">
                    <MudText Typo="Typo.caption" Color="Color.Primary">Notes</MudText>
                    <MudText>@Guarantor.Notes</MudText>
                </MudItem>
            }
            @if (IsExpiringSoon)
            {
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Warning" Class="mt-2">
                        This guarantee is expiring within 30 days!
                    </MudAlert>
                </MudItem>
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Close" Variant="Variant.Text" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public LoanGuarantorResponse Guarantor { get; set; } = null!;

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    private bool IsExpiringSoon => Guarantor.ExpiryDate.HasValue &&
                                   Guarantor.ExpiryDate.Value <= DateOnly.FromDateTime(DateTime.Today.AddDays(30));

    private Color GetStatusColor(string? status) => status switch
    {
        "Pending" => Color.Warning,
        "Approved" => Color.Success,
        "Rejected" => Color.Error,
        "Expired" => Color.Default,
        _ => Color.Default
    };

    private void Close() => MudDialog.Close();
}
