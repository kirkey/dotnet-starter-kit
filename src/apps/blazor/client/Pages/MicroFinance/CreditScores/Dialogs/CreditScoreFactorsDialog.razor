<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Analytics" Class="mr-2" />
            Score Factors - @CreditScore.MemberName
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
                    <MudText Typo="Typo.h4" Color="@GetScoreColor()">@CreditScore.Score.ToString("N0")</MudText>
                    <MudChip T="string" Size="Size.Large" Color="@GetGradeColor()">Grade @CreditScore.Grade</MudChip>
                </MudStack>
            </MudItem>
            <MudItem xs="12">
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Score Contributing Factors</MudText>
            </MudItem>
            @if (!string.IsNullOrEmpty(CreditScore.ScoreFactors))
            {
                @foreach (var factor in ParseFactors(CreditScore.ScoreFactors))
                {
                    <MudItem xs="12">
                        <MudPaper Class="pa-3 mb-2" Elevation="1">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack>
                                    <MudText Typo="Typo.subtitle2">@factor.Name</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@factor.Description</MudText>
                                </MudStack>
                                <MudStack AlignItems="AlignItems.End">
                                    <MudText Color="@(factor.Impact >= 0 ? Color.Success : Color.Error)">
                                        @(factor.Impact >= 0 ? "+" : "")@factor.Impact
                                    </MudText>
                                    <MudText Typo="Typo.caption">@factor.Weight%</MudText>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                }
            }
            else
            {
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Info">
                        No detailed score factors available for this credit score.
                    </MudAlert>
                </MudItem>
            }
            <MudItem xs="12">
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Key Metrics</MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudCard>
                    <MudCardContent>
                        <MudText Typo="Typo.caption">Probability of Default</MudText>
                        <MudText Typo="Typo.h6" Color="@(CreditScore.ProbabilityOfDefault > 0.2m ? Color.Error : Color.Success)">
                            @((CreditScore.ProbabilityOfDefault ?? 0 * 100).ToString("N1"))%
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudCard>
                    <MudCardContent>
                        <MudText Typo="Typo.caption">Risk Level</MudText>
                        <MudText Typo="Typo.h6" Color="@GetRiskColor()">@GetRiskLevel()</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Close" Variant="Variant.Text" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public CreditScoreResponse CreditScore { get; set; } = null!;

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    private record ScoreFactor(string Name, string Description, int Impact, int Weight);

    private List<ScoreFactor> ParseFactors(string factorsJson)
    {
        // Parse score factors from JSON or return sample factors
        // In production, this would parse the actual JSON data
        return new List<ScoreFactor>
        {
            new("Payment History", "On-time payments over last 12 months", 85, 35),
            new("Credit Utilization", "Current balance vs credit limit", -15, 30),
            new("Account Age", "Length of credit history", 45, 15),
            new("Credit Mix", "Types of credit accounts", 20, 10),
            new("Recent Inquiries", "Credit applications in last 6 months", -10, 10)
        };
    }

    private Color GetScoreColor()
    {
        var percentage = CreditScore.Score / CreditScore.ScoreMax;
        return percentage switch
        {
            >= 0.8m => Color.Success,
            >= 0.6m => Color.Info,
            >= 0.4m => Color.Warning,
            _ => Color.Error
        };
    }

    private Color GetGradeColor() => CreditScore.Grade switch
    {
        "A" => Color.Success,
        "B" => Color.Info,
        "C" => Color.Warning,
        "D" => Color.Error,
        "E" => Color.Error,
        _ => Color.Default
    };

    private string GetRiskLevel()
    {
        var percentage = CreditScore.Score / CreditScore.ScoreMax;
        return percentage switch
        {
            >= 0.8m => "Low Risk",
            >= 0.6m => "Medium-Low Risk",
            >= 0.4m => "Medium Risk",
            >= 0.2m => "High Risk",
            _ => "Very High Risk"
        };
    }

    private Color GetRiskColor()
    {
        var percentage = CreditScore.Score / CreditScore.ScoreMax;
        return percentage switch
        {
            >= 0.8m => Color.Success,
            >= 0.6m => Color.Info,
            >= 0.4m => Color.Warning,
            _ => Color.Error
        };
    }

    private void Close() => MudDialog.Close();
}
