<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Score" Class="mr-2" />
            Credit Score Details
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Primary">Member Name</MudText>
                <MudText>@CreditScore.MemberName</MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Primary">Member Number</MudText>
                <MudText>@CreditScore.MemberNumber</MudText>
            </MudItem>
            <MudItem xs="12">
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Score Information</MudText>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudText Typo="Typo.caption" Color="Color.Primary">Credit Score</MudText>
                <MudText Typo="Typo.h4" Color="@GetScoreColor(CreditScore.Score, CreditScore.ScoreMax)">
                    @CreditScore.Score.ToString("N0")
                </MudText>
                <MudText Typo="Typo.caption">
                    Range: @CreditScore.ScoreMin - @CreditScore.ScoreMax
                </MudText>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudText Typo="Typo.caption" Color="Color.Primary">Grade</MudText>
                <MudChip T="string" Size="Size.Large" Color="@GetGradeColor(CreditScore.Grade)">
                    @CreditScore.Grade
                </MudChip>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudText Typo="Typo.caption" Color="Color.Primary">Probability of Default</MudText>
                <MudText Typo="Typo.h5" Color="@(CreditScore.ProbabilityOfDefault > 0.2m ? Color.Error : Color.Success)">
                    @((CreditScore.ProbabilityOfDefault ?? 0 * 100).ToString("N1"))%
                </MudText>
            </MudItem>
            <MudItem xs="12">
                <MudProgressLinear Color="@GetScoreColor(CreditScore.Score, CreditScore.ScoreMax)" 
                                   Size="Size.Large"
                                   Value="@GetScorePercentage()"
                                   Class="my-2" />
            </MudItem>
            <MudItem xs="12">
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Source & Validity</MudText>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudText Typo="Typo.caption" Color="Color.Primary">Score Type</MudText>
                <MudText>@CreditScore.ScoreType</MudText>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudText Typo="Typo.caption" Color="Color.Primary">Source</MudText>
                <MudText>@(CreditScore.Source ?? "Internal")</MudText>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudText Typo="Typo.caption" Color="Color.Primary">Score Model</MudText>
                <MudText>@(CreditScore.ScoreModel ?? "Default")</MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Primary">Created On</MudText>
                <MudText>@CreditScore.CreatedOn.ToString("dd/MM/yyyy HH:mm")</MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Primary">Valid Until</MudText>
                <MudText Color="@(CreditScore.IsExpired ? Color.Error : Color.Default)">
                    @(CreditScore.ValidUntil?.ToString("dd/MM/yyyy") ?? "No Expiry")
                    @if (CreditScore.IsExpired)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Error" Class="ml-2">Expired</MudChip>
                    }
                </MudText>
            </MudItem>
            @if (CreditScore.IsExpired)
            {
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Warning" Class="mt-2">
                        This credit score has expired. Consider refreshing the score before making credit decisions.
                    </MudAlert>
                </MudItem>
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Close" Variant="Variant.Text" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public CreditScoreResponse CreditScore { get; set; } = null!;

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    private double GetScorePercentage()
    {
        var range = (double)(CreditScore.ScoreMax - CreditScore.ScoreMin);
        if (range == 0) return 0;
        return (double)(CreditScore.Score - CreditScore.ScoreMin) / range * 100;
    }

    private Color GetScoreColor(decimal score, decimal maxScore)
    {
        var percentage = score / maxScore;
        return percentage switch
        {
            >= 0.8m => Color.Success,
            >= 0.6m => Color.Info,
            >= 0.4m => Color.Warning,
            _ => Color.Error
        };
    }

    private Color GetGradeColor(string? grade) => grade switch
    {
        "A" => Color.Success,
        "B" => Color.Info,
        "C" => Color.Warning,
        "D" => Color.Error,
        "E" => Color.Error,
        _ => Color.Default
    };

    private void Close() => MudDialog.Close();
}
