@namespace FSH.Starter.Blazor.Client.Pages.MicroFinance.CollateralValuations

<MudDialog>
    <DialogContent>
        @if (Valuation is not null)
        {
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.h6" Class="mb-2">Valuation Information</MudText>
                    <MudSimpleTable Dense="true" Hover="true" Bordered="true" Striped="true">
                        <tbody>
                            <tr><td><strong>ID</strong></td><td>@Valuation.Id</td></tr>
                            <tr><td><strong>Reference</strong></td><td>@Valuation.ValuationReference</td></tr>
                            <tr><td><strong>Collateral ID</strong></td><td>@Valuation.CollateralId</td></tr>
                            <tr><td><strong>Valuation Date</strong></td><td>@Valuation.ValuationDate.ToString("yyyy-MM-dd")</td></tr>
                            <tr><td><strong>Expiry Date</strong></td><td>@(Valuation.ExpiryDate?.ToString("yyyy-MM-dd") ?? "N/A")</td></tr>
                            <tr><td><strong>Method</strong></td><td>@Valuation.ValuationMethod</td></tr>
                            <tr><td><strong>Condition</strong></td><td>@(Valuation.Condition ?? "N/A")</td></tr>
                            <tr><td><strong>Status</strong></td><td><MudChip T="string" Color="@GetStatusColor(Valuation.Status)" Size="Size.Small">@Valuation.Status</MudChip></td></tr>
                        </tbody>
                    </MudSimpleTable>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.h6" Class="mb-2">Appraiser Details</MudText>
                    <MudSimpleTable Dense="true" Hover="true" Bordered="true" Striped="true">
                        <tbody>
                            <tr><td><strong>Appraiser Name</strong></td><td>@(Valuation.AppraiserName ?? "N/A")</td></tr>
                            <tr><td><strong>Appraiser Company</strong></td><td>@(Valuation.AppraiserCompany ?? "N/A")</td></tr>
                            <tr><td><strong>Appraiser License</strong></td><td>@(Valuation.AppraiserLicense ?? "N/A")</td></tr>
                        </tbody>
                    </MudSimpleTable>
                    
                    <MudText Typo="Typo.h6" Class="mt-4 mb-2">Valuation Amounts</MudText>
                    <MudSimpleTable Dense="true" Hover="true" Bordered="true" Striped="true">
                        <tbody>
                            <tr><td><strong>Market Value</strong></td><td><strong>@Valuation.MarketValue.ToString("N2")</strong></td></tr>
                            <tr><td><strong>Forced Sale Value</strong></td><td>@Valuation.ForcedSaleValue.ToString("N2")</td></tr>
                            <tr><td><strong>Insurable Value</strong></td><td>@Valuation.InsurableValue.ToString("N2")</td></tr>
                            @if (Valuation.PreviousValue.HasValue)
                            {
                                <tr><td><strong>Previous Value</strong></td><td>@Valuation.PreviousValue.Value.ToString("N2")</td></tr>
                                <tr><td><strong>Value Change</strong></td><td class="@(Valuation.ValueChange >= 0 ? "mud-success-text" : "mud-error-text")">@(Valuation.ValueChange?.ToString("N2") ?? "N/A") (@(Valuation.ValueChangePercent?.ToString("N1") ?? "N/A")%)</td></tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </MudItem>
                <MudItem xs="12">
                    @if (!string.IsNullOrEmpty(Valuation.Notes))
                    {
                        <MudText Typo="Typo.h6" Class="mb-2">Notes</MudText>
                        <MudPaper Elevation="0" Class="pa-3 mud-background-gray">
                            <MudText>@Valuation.Notes</MudText>
                        </MudPaper>
                    }
                    @if (Valuation.ApprovedById.HasValue)
                    {
                        <MudText Typo="Typo.h6" Class="mt-4 mb-2">Approval</MudText>
                        <MudSimpleTable Dense="true" Hover="true" Bordered="true" Striped="true">
                            <tbody>
                                <tr><td><strong>Approved By</strong></td><td>@Valuation.ApprovedById</td></tr>
                                <tr><td><strong>Approved Date</strong></td><td>@(Valuation.ApprovedDate?.ToString("yyyy-MM-dd") ?? "N/A")</td></tr>
                            </tbody>
                        </MudSimpleTable>
                    }
                    @if (!string.IsNullOrEmpty(Valuation.RejectionReason))
                    {
                        <MudAlert Severity="Severity.Error" Class="mt-4">@Valuation.RejectionReason</MudAlert>
                    }
                </MudItem>
            </MudGrid>
        }
        else
        {
            <MudText>No valuation data available.</MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public CollateralValuationResponse? Valuation { get; set; }

    private void Close() => MudDialog.Close();

    private static Color GetStatusColor(string? status) => status switch
    {
        "Pending" => Color.Warning,
        "Approved" => Color.Success,
        "Rejected" => Color.Error,
        "Expired" => Color.Default,
        "Active" => Color.Info,
        _ => Color.Default
    };
}
