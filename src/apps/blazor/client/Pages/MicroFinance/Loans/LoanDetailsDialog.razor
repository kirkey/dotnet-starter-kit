@namespace FSH.Starter.Blazor.Client.Pages.MicroFinance.Loans

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.MonetizationOn" Class="mr-3 mb-n1" />
            Loan Details
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_loading)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (_loan != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Loan Information</strong></MudText>
                    <MudDivider />
                </MudItem>
                
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.caption">Loan Number</MudText>
                    <MudText Typo="Typo.body1"><strong>@_loan.LoanNumber</strong></MudText>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.caption">Status</MudText>
                    <MudChip T="string" Color="@GetStatusColor(_loan.Status)" Size="Size.Small">@_loan.Status</MudChip>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.caption">Member</MudText>
                    <MudText Typo="Typo.body1">@_loan.MemberName</MudText>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.caption">Product</MudText>
                    <MudText Typo="Typo.body1">@_loan.LoanProductName</MudText>
                </MudItem>
                
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle1" Class="mb-2 mt-4"><strong>Financial Details</strong></MudText>
                    <MudDivider />
                </MudItem>
                
                <MudItem xs="12" sm="6" md="3">
                    <MudText Typo="Typo.caption">Principal Amount</MudText>
                    <MudText Typo="Typo.h6" Color="Color.Primary">@_loan.PrincipalAmount.ToString("C")</MudText>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="3">
                    <MudText Typo="Typo.caption">Interest Rate</MudText>
                    <MudText Typo="Typo.body1">@_loan.InterestRate.ToString("F2")%</MudText>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="3">
                    <MudText Typo="Typo.caption">Term</MudText>
                    <MudText Typo="Typo.body1">@_loan.TermMonths months</MudText>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="3">
                    <MudText Typo="Typo.caption">Repayment Frequency</MudText>
                    <MudText Typo="Typo.body1">@_loan.RepaymentFrequency</MudText>
                </MudItem>
                
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle1" Class="mb-2 mt-4"><strong>Outstanding Balances</strong></MudText>
                    <MudDivider />
                </MudItem>
                
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.caption">Outstanding Principal</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Warning">@_loan.OutstandingPrincipal.ToString("C")</MudText>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.caption">Outstanding Interest</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Warning">@_loan.OutstandingInterest.ToString("C")</MudText>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.caption">Total Outstanding</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Error">@((_loan.OutstandingPrincipal + _loan.OutstandingInterest).ToString("C"))</MudText>
                </MudItem>
                
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle1" Class="mb-2 mt-4"><strong>Dates</strong></MudText>
                    <MudDivider />
                </MudItem>
                
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.caption">Application Date</MudText>
                    <MudText Typo="Typo.body1">@_loan.ApplicationDate.ToString("d")</MudText>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.caption">Approval Date</MudText>
                    <MudText Typo="Typo.body1">@(_loan.ApprovalDate?.ToString("d") ?? "N/A")</MudText>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.caption">Disbursement Date</MudText>
                    <MudText Typo="Typo.body1">@(_loan.DisbursementDate?.ToString("d") ?? "N/A")</MudText>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.caption">Expected End Date</MudText>
                    <MudText Typo="Typo.body1">@(_loan.ExpectedEndDate?.ToString("d") ?? "N/A")</MudText>
                </MudItem>
                
                @if (!string.IsNullOrWhiteSpace(_loan.Purpose))
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.subtitle1" Class="mb-2 mt-4"><strong>Purpose</strong></MudText>
                        <MudDivider />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudText Typo="Typo.body1">@_loan.Purpose</MudText>
                    </MudItem>
                }
            </MudGrid>
        }
        else
        {
            <MudAlert Severity="Severity.Error">Unable to load loan details.</MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close" Variant="Variant.Filled" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public DefaultIdType LoanId { get; set; }

    private LoanResponse? _loan;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _loan = await Client.GetLoanAsync("1", LoanId);
        }
        finally
        {
            _loading = false;
        }
    }

    private Color GetStatusColor(string? status) => status switch
    {
        "Pending" => Color.Info,
        "Approved" => Color.Success,
        "Disbursed" => Color.Primary,
        "Active" => Color.Primary,
        "Closed" => Color.Default,
        "Rejected" => Color.Error,
        "WrittenOff" => Color.Error,
        _ => Color.Default
    };

    private void Close() => MudDialog.Close();
}
