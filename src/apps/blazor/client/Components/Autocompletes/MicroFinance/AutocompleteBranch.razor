@using FSH.Starter.Blazor.Infrastructure.Api
@using System.Linq.Expressions
@namespace FSH.Starter.Blazor.Client.Components.Autocompletes.MicroFinance
@inject IClient Client

<MudAutocomplete T="BranchSummaryResponse"
                 Value="_selectedBranch"
                 ValueChanged="@OnBranchSelected"
                 SearchFunc="@SearchBranches"
                 ToStringFunc="@(branch => branch != null ? $"{branch.Code} - {branch.Name}" : string.Empty)"
                 Label="@Label"
                 Required="@Required"
                 RequiredError="@RequiredError"
                 Variant="@Variant"
                 AdornmentIcon="@Icons.Material.Filled.Business"
                 AdornmentColor="@AdornmentColor"
                 HelperText="@HelperText"
                 Disabled="@Disabled"
                 Dense="@Dense"
                 Clearable="@Clearable"
                 ResetValueOnEmptyText="@ResetValueOnEmptyText" />

@code {
    private BranchSummaryResponse? _selectedBranch;

    /// <summary>
    /// Gets or sets the selected branch ID (Guid).
    /// </summary>
    [Parameter]
    public Guid Value { get; set; }

    /// <summary>
    /// Gets or sets the callback when value changes.
    /// </summary>
    [Parameter]
    public EventCallback<Guid> ValueChanged { get; set; }

    /// <summary>
    /// Expression for validation.
    /// </summary>
    [Parameter]
    public Expression<Func<Guid>>? For { get; set; }

    /// <summary>
    /// Gets or sets the label text.
    /// </summary>
    [Parameter]
    public string Label { get; set; } = "Branch";

    /// <summary>
    /// Gets or sets whether the field is required.
    /// </summary>
    [Parameter]
    public bool Required { get; set; } = true;

    /// <summary>
    /// Gets or sets the required field error message.
    /// </summary>
    [Parameter]
    public string RequiredError { get; set; } = "Branch is required";

    /// <summary>
    /// Gets or sets the helper text.
    /// </summary>
    [Parameter]
    public string HelperText { get; set; } = "Search by branch code or name";

    /// <summary>
    /// Gets or sets the variant style.
    /// </summary>
    [Parameter]
    public Variant Variant { get; set; } = Variant.Filled;

    /// <summary>
    /// Gets or sets the adornment color.
    /// </summary>
    [Parameter]
    public Color AdornmentColor { get; set; } = Color.Primary;

    /// <summary>
    /// Gets or sets whether the field is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Gets or sets whether to use dense spacing.
    /// </summary>
    [Parameter]
    public bool Dense { get; set; }

    /// <summary>
    /// Gets or sets whether the field is clearable.
    /// </summary>
    [Parameter]
    public bool Clearable { get; set; } = true;

    /// <summary>
    /// Gets or sets whether to reset value on empty text.
    /// </summary>
    [Parameter]
    public bool ResetValueOnEmptyText { get; set; } = true;

    /// <summary>
    /// Optional filter to only show active branches.
    /// </summary>
    [Parameter]
    public bool? ActiveOnly { get; set; } = true;

    protected override async Task OnParametersSetAsync()
    {
        // Load the branch if we have a value but no selected branch
        if (Value != Guid.Empty && (_selectedBranch == null || _selectedBranch.Id != Value))
        {
            try
            {
                var branch = await Client.GetBranchAsync("1", Value);
                if (branch != null)
                {
                    _selectedBranch = new BranchSummaryResponse
                    {
                        Id = branch.Id,
                        Code = branch.Code,
                        Name = branch.Name,
                        BranchType = branch.BranchType,
                        Status = branch.Status,
                        ManagerName = branch.ManagerName
                    };
                }
            }
            catch
            {
                _selectedBranch = null;
            }
        }
        else if (Value == Guid.Empty)
        {
            _selectedBranch = null;
        }
    }

    private async Task OnBranchSelected(BranchSummaryResponse? branch)
    {
        _selectedBranch = branch;
        var newValue = branch?.Id ?? Guid.Empty;
        if (Value != newValue)
        {
            Value = newValue;
            await ValueChanged.InvokeAsync(newValue);
        }
    }

    private async Task<IEnumerable<BranchSummaryResponse>> SearchBranches(string searchValue, CancellationToken cancellationToken)
    {
        try
        {
            var request = new SearchBranchesCommand
            {
                Filter = new PaginationFilter
                {
                    Keyword = searchValue ?? string.Empty,
                    PageNumber = 1,
                    PageSize = 20
                }
            };

            var response = await Client.SearchBranchesAsync("1", request, cancellationToken);
            var items = response?.Items?.ToList() ?? new List<BranchSummaryResponse>();
            
            // Filter by active status if required
            if (ActiveOnly == true)
            {
                items = items.Where(b => b.Status == "Active").ToList();
            }
            
            return items;
        }
        catch
        {
            return new List<BranchSummaryResponse>();
        }
    }
}
