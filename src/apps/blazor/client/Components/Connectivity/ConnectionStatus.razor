@using FSH.Starter.Blazor.Infrastructure.Notifications
@using MediatR.Courier
@inject ICourier Courier

@*
    Displays the SignalR messaging connection status indicator.
    Shows connected, connecting, or disconnected state with appropriate icon and color.
*@
<MudTooltip Arrow Text="@TooltipText">
    <MudIconButton Icon="@Icon" Color="@IconColor"/>
</MudTooltip>

@code {
    private string TooltipText { get; set; } = "No Connection";
    private string Icon { get; set; } = Icons.Material.Filled.SignalWifi0Bar;
    private Color IconColor { get; set; } = Color.Error;

    /// <summary>
    /// Gets or sets the cascading messaging connection.
    /// </summary>
    [CascadingParameter]
    private MessagingConnection? MessagingConnection { get; set; }

    /// <inheritdoc/>
    protected override void OnInitialized()
    {
        if (MessagingConnection is not null)
        {
            // Set initial state from the cascading parameter
            SetConnectionState(MessagingConnection.ConnectionState, MessagingConnection.ConnectionId);

            // Subscribe to connection state changes
            Courier.SubscribeWeak<NotificationWrapper<ConnectionStateChanged>>(wrapper =>
            {
                SetConnectionState(wrapper.Notification.State, wrapper.Notification.Message);
                // StateHasChanged is called inside SetConnectionState
            });
        }
    }

    /// <summary>
    /// Updates the visual state based on connection status.
    /// </summary>
    /// <param name="state">The connection state.</param>
    /// <param name="message">The status message or connection ID.</param>
    private void SetConnectionState(ConnectionState state, string? message)
    {
        (TooltipText, Icon, IconColor) = state switch
        {
            ConnectionState.Connected =>
            (
                $"Connected to Messaging Server (ID: {message})",
                Icons.Material.Filled.SignalWifiStatusbar4Bar,
                Color.Success
            ),
            ConnectionState.Connecting =>
            (
                $"Connecting to server... ({message})",
                Icons.Material.Filled.SignalWifiStatusbarConnectedNoInternet4,
                Color.Warning
            ),
            ConnectionState.Disconnected =>
            (
                $"Disconnected from server ({message})",
                Icons.Material.Filled.SignalWifiOff,
                Color.Error
            ),
            _ => throw new ArgumentOutOfRangeException(nameof(state), state, null)
        };

        StateHasChanged();
    }
}

