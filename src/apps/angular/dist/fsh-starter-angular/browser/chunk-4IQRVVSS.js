import{a as o}from"./chunk-7FXRJWRW.js";import{c as _}from"./chunk-VLA6YYWX.js";import{a as T}from"./chunk-NW6BZQUB.js";import{D as i,X as u,_ as g,da as h,fb as l,n,xc as m}from"./chunk-ENBBOSSX.js";var p="auth_token",d="refresh_token",f="user_data",k="tenant_id",R=(()=>{class r{http;router;tokenUrl="/api/token";apiUrl=o.apiUrl;_isAuthenticated=l(this.hasValidToken());_currentUser=l(this.loadUserFromStorage());_currentTenant=l(this.loadTenantFromStorage());isAuthenticated=this._isAuthenticated.asReadonly();currentUser=this._currentUser.asReadonly();currentTenant=this._currentTenant.asReadonly();userFullName=m(()=>{let e=this._currentUser();return e?`${e.firstName} ${e.lastName}`:""});userInitials=m(()=>{let e=this._currentUser();return e?`${e.firstName?.charAt(0)||""}${e.lastName?.charAt(0)||""}`.toUpperCase():""});constructor(e,t){this.http=e,this.router=t}login(e,t=o.defaultTenant){this.setTenant(t);let a=e.deviceType||"Web",s=`${this.tokenUrl}?deviceType=${a}`,S={email:e.email,password:e.password};return this.http.post(s,S).pipe(u(c=>this.handleAuthResponse(c)),i(c=>(this.clearAuth(),n(()=>c))))}register(e){return this.http.post(`${o.apiUrl}/users/self-register`,e).pipe(i(t=>n(()=>t)))}logout(){this.clearAuth(),this.router.navigate(["/auth/login"])}refreshToken(){let e=this.getToken(),t=this.getRefreshToken();if(!e||!t)return n(()=>new Error("No tokens available"));let a={token:e,refreshToken:t};return this.http.post(`${this.tokenUrl}/refresh`,a).pipe(u(s=>this.handleAuthResponse(s)),i(s=>(this.clearAuth(),n(()=>s))))}getToken(){return localStorage.getItem(p)}getRefreshToken(){return localStorage.getItem(d)}getTenant(){return this._currentTenant()}setTenant(e){localStorage.setItem(k,e),this._currentTenant.set(e)}setUser(e){localStorage.setItem(f,JSON.stringify(e)),this._currentUser.set(e)}handleAuthResponse(e){localStorage.setItem(p,e.token),localStorage.setItem(d,e.refreshToken),this._isAuthenticated.set(!0);let t=this.decodeToken(e.token);t&&this.setUser(t)}clearAuth(){localStorage.removeItem(p),localStorage.removeItem(d),localStorage.removeItem(f),this._isAuthenticated.set(!1),this._currentUser.set(null)}hasValidToken(){let e=this.getToken();if(!e)return!1;try{let a=JSON.parse(atob(e.split(".")[1])).exp*1e3;return Date.now()<a}catch{return!1}}loadUserFromStorage(){let e=localStorage.getItem(f);return e?JSON.parse(e):null}loadTenantFromStorage(){return localStorage.getItem(k)||o.defaultTenant}decodeToken(e){try{let t=JSON.parse(atob(e.split(".")[1]));return{id:t.uid||t.sub,userName:t.name||t.email,firstName:t.firstName||t.given_name||"",lastName:t.lastName||t.family_name||"",email:t.email,imageUrl:t.image_url,isActive:!0,emailConfirmed:t.email_verified==="true"}}catch{return null}}static \u0275fac=function(t){return new(t||r)(h(T),h(_))};static \u0275prov=g({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();export{R as a};
