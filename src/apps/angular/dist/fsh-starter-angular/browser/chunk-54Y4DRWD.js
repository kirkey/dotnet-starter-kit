import{a as n}from"./chunk-NVQOZQVQ.js";import{b as T}from"./chunk-E7PAFU6A.js";import{b as g}from"./chunk-TPD4TER6.js";import{G as o,_ as u,ba as f,ga as c,ib as i,r as s,zc as h}from"./chunk-LWQQNMXP.js";var m="auth_token",p="refresh_token",d="user_data",_="tenant_id",E=(()=>{class a{http;router;apiUrl=`${n.apiUrl}/tokens`;_isAuthenticated=i(this.hasValidToken());_currentUser=i(this.loadUserFromStorage());_currentTenant=i(this.loadTenantFromStorage());isAuthenticated=this._isAuthenticated.asReadonly();currentUser=this._currentUser.asReadonly();currentTenant=this._currentTenant.asReadonly();userFullName=h(()=>{let t=this._currentUser();return t?`${t.firstName} ${t.lastName}`:""});userInitials=h(()=>{let t=this._currentUser();return t?`${t.firstName?.charAt(0)||""}${t.lastName?.charAt(0)||""}`.toUpperCase():""});constructor(t,e){this.http=t,this.router=e}login(t,e=n.defaultTenant){return this.setTenant(e),this.http.post(this.apiUrl,t).pipe(u(r=>this.handleAuthResponse(r)),o(r=>(this.clearAuth(),s(()=>r))))}register(t){return this.http.post(`${n.apiUrl}/users/self-register`,t).pipe(o(e=>s(()=>e)))}logout(){this.clearAuth(),this.router.navigate(["/auth/login"])}refreshToken(){let t=this.getToken(),e=this.getRefreshToken();if(!t||!e)return s(()=>new Error("No tokens available"));let r={token:t,refreshToken:e};return this.http.post(`${this.apiUrl}/refresh`,r).pipe(u(l=>this.handleAuthResponse(l)),o(l=>(this.clearAuth(),s(()=>l))))}getToken(){return localStorage.getItem(m)}getRefreshToken(){return localStorage.getItem(p)}getTenant(){return this._currentTenant()}setTenant(t){localStorage.setItem(_,t),this._currentTenant.set(t)}setUser(t){localStorage.setItem(d,JSON.stringify(t)),this._currentUser.set(t)}handleAuthResponse(t){localStorage.setItem(m,t.token),localStorage.setItem(p,t.refreshToken),this._isAuthenticated.set(!0);let e=this.decodeToken(t.token);e&&this.setUser(e)}clearAuth(){localStorage.removeItem(m),localStorage.removeItem(p),localStorage.removeItem(d),this._isAuthenticated.set(!1),this._currentUser.set(null)}hasValidToken(){let t=this.getToken();if(!t)return!1;try{let r=JSON.parse(atob(t.split(".")[1])).exp*1e3;return Date.now()<r}catch{return!1}}loadUserFromStorage(){let t=localStorage.getItem(d);return t?JSON.parse(t):null}loadTenantFromStorage(){return localStorage.getItem(_)||n.defaultTenant}decodeToken(t){try{let e=JSON.parse(atob(t.split(".")[1]));return{id:e.uid||e.sub,userName:e.name||e.email,firstName:e.firstName||e.given_name||"",lastName:e.lastName||e.family_name||"",email:e.email,imageUrl:e.image_url,isActive:!0,emailConfirmed:e.email_verified==="true"}}catch{return null}}static \u0275fac=function(e){return new(e||a)(c(g),c(T))};static \u0275prov=f({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();export{E as a};
